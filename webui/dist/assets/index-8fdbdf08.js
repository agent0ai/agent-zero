(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function s(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=s(i);fetch(i.href,a)}})();function Ot(t,e={}){if(!t)return"";const s=new Date(t),n={dateStyle:"medium",timeStyle:"medium"};return new Intl.DateTimeFormat(void 0,{...n,...e}).format(s)}function Ye(t,e="full"){if(!t)return"";const s={full:{dateStyle:"medium",timeStyle:"medium"},date:{dateStyle:"medium"},time:{timeStyle:"medium"},short:{dateStyle:"short",timeStyle:"short"}};return Ot(t,s[e]||s.full)}function v(){return Intl.DateTimeFormat().resolvedOptions().timeZone}let O=null;async function qt(t,e=0){try{let s=t;if(O!==null&&(clearInterval(O),O=null),e>0){const a=c=>{const l=new URL(c,window.location.origin);return l.searchParams.set("t",Date.now()),l.toString()},o=()=>{const c=document.querySelector("#image-viewer-container");if(!c)return!1;let l=c;for(;l;){const d=window.getComputedStyle(l);if(d.display==="none"||d.visibility==="hidden"||d.opacity==="0")return!1;l=l.parentElement}return!0},r=async c=>{const l=a(t),d=new Promise((u,h)=>{const g=new Image;g.onload=()=>u(l),g.onerror=h,g.src=l});try{const u=await d;c&&o()&&(c.src=u)}catch(u){console.error("Failed to preload image:",u)}};s=a(t),O=setInterval(()=>{if(!o()){clearInterval(O),O=null;return}const c=document.querySelector(".image-viewer-img");c&&r(c)},e)}const n=`<div id="image-viewer-container"><img class="image-viewer-img" src="${s}" /></div>`,i=t.split("/").pop();await window.genericModalProxy.openModal(i,"",n)}catch(s){window.toastFetchError("Error fetching history",s);return}}function Re(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var N=Re();function dt(t){N=t}var V={exec:()=>null};function m(t,e=""){let s=typeof t=="string"?t:t.source;const n={replace:(i,a)=>{let o=typeof a=="string"?a:a.source;return o=o.replace(x.caret,"$1"),s=s.replace(i,o),n},getRegex:()=>new RegExp(s,e)};return n}var x={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] /,listReplaceTask:/^\[[ xX]\] +/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:t=>new RegExp(`^( {0,3}${t})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:t=>new RegExp(`^ {0,${Math.min(3,t-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:t=>new RegExp(`^ {0,${Math.min(3,t-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:t=>new RegExp(`^ {0,${Math.min(3,t-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:t=>new RegExp(`^ {0,${Math.min(3,t-1)}}#`),htmlBeginRegex:t=>new RegExp(`^ {0,${Math.min(3,t-1)}}<(?:[a-z].*>|!--)`,"i")},jt=/^(?:[ \t]*(?:\n|$))+/,Ht=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,Ut=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,se=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,Gt=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,De=/(?:[*+-]|\d{1,9}[.)])/,ut=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,ht=m(ut).replace(/bull/g,De).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),Zt=m(ut).replace(/bull/g,De).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),Me=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,Jt=/^[^\n]+/,Pe=/(?!\s*\])(?:\\.|[^\[\]\\])+/,Wt=m(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",Pe).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),Vt=m(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,De).getRegex(),we="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",ze=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,Qt=m("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",ze).replace("tag",we).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),pt=m(Me).replace("hr",se).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",we).getRegex(),Kt=m(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",pt).getRegex(),Fe={blockquote:Kt,code:Ht,def:Wt,fences:Ut,heading:Gt,hr:se,html:Qt,lheading:ht,list:Vt,newline:jt,paragraph:pt,table:V,text:Jt},Xe=m("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",se).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",we).getRegex(),Yt={...Fe,lheading:Zt,table:Xe,paragraph:m(Me).replace("hr",se).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",Xe).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",we).getRegex()},Xt={...Fe,html:m(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",ze).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:V,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:m(Me).replace("hr",se).replace("heading",` *#{1,6} *[^
]`).replace("lheading",ht).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},es=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,ts=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,gt=/^( {2,}|\\)\n(?!\s*$)/,ss=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,Te=/[\p{P}\p{S}]/u,Be=/[\s\p{P}\p{S}]/u,ft=/[^\s\p{P}\p{S}]/u,ns=m(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,Be).getRegex(),mt=/(?!~)[\p{P}\p{S}]/u,is=/(?!~)[\s\p{P}\p{S}]/u,as=/(?:[^\s\p{P}\p{S}]|~)/u,os=/\[[^[\]]*?\]\((?:\\.|[^\\\(\)]|\((?:\\.|[^\\\(\)])*\))*\)|`[^`]*?`|<[^<>]*?>/g,kt=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,rs=m(kt,"u").replace(/punct/g,Te).getRegex(),ls=m(kt,"u").replace(/punct/g,mt).getRegex(),yt="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",cs=m(yt,"gu").replace(/notPunctSpace/g,ft).replace(/punctSpace/g,Be).replace(/punct/g,Te).getRegex(),ds=m(yt,"gu").replace(/notPunctSpace/g,as).replace(/punctSpace/g,is).replace(/punct/g,mt).getRegex(),us=m("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,ft).replace(/punctSpace/g,Be).replace(/punct/g,Te).getRegex(),hs=m(/\\(punct)/,"gu").replace(/punct/g,Te).getRegex(),ps=m(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),gs=m(ze).replace("(?:-->|$)","-->").getRegex(),fs=m("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",gs).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),pe=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,ms=m(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",pe).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),wt=m(/^!?\[(label)\]\[(ref)\]/).replace("label",pe).replace("ref",Pe).getRegex(),Tt=m(/^!?\[(ref)\](?:\[\])?/).replace("ref",Pe).getRegex(),ks=m("reflink|nolink(?!\\()","g").replace("reflink",wt).replace("nolink",Tt).getRegex(),Ne={_backpedal:V,anyPunctuation:hs,autolink:ps,blockSkip:os,br:gt,code:ts,del:V,emStrongLDelim:rs,emStrongRDelimAst:cs,emStrongRDelimUnd:us,escape:es,link:ms,nolink:Tt,punctuation:ns,reflink:wt,reflinkSearch:ks,tag:fs,text:ss,url:V},ys={...Ne,link:m(/^!?\[(label)\]\((.*?)\)/).replace("label",pe).getRegex(),reflink:m(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",pe).getRegex()},Ce={...Ne,emStrongRDelimAst:ds,emStrongLDelim:ls,url:m(/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,"i").replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\.|[^\\])*?(?:\\.|[^\s~\\]))\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/},ws={...Ce,br:m(gt).replace("{2,}","*").getRegex(),text:m(Ce.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},re={normal:Fe,gfm:Yt,pedantic:Xt},J={normal:Ne,gfm:Ce,breaks:ws,pedantic:ys},Ts={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},et=t=>Ts[t];function $(t,e){if(e){if(x.escapeTest.test(t))return t.replace(x.escapeReplace,et)}else if(x.escapeTestNoEncode.test(t))return t.replace(x.escapeReplaceNoEncode,et);return t}function tt(t){try{t=encodeURI(t).replace(x.percentDecode,"%")}catch{return null}return t}function st(t,e){const s=t.replace(x.findPipe,(a,o,r)=>{let c=!1,l=o;for(;--l>=0&&r[l]==="\\";)c=!c;return c?"|":" |"}),n=s.split(x.splitPipe);let i=0;if(n[0].trim()||n.shift(),n.length>0&&!n.at(-1)?.trim()&&n.pop(),e)if(n.length>e)n.splice(e);else for(;n.length<e;)n.push("");for(;i<n.length;i++)n[i]=n[i].trim().replace(x.slashPipe,"|");return n}function W(t,e,s){const n=t.length;if(n===0)return"";let i=0;for(;i<n;){const a=t.charAt(n-i-1);if(a===e&&!s)i++;else if(a!==e&&s)i++;else break}return t.slice(0,n-i)}function bs(t,e){if(t.indexOf(e[1])===-1)return-1;let s=0;for(let n=0;n<t.length;n++)if(t[n]==="\\")n++;else if(t[n]===e[0])s++;else if(t[n]===e[1]&&(s--,s<0))return n;return s>0?-2:-1}function nt(t,e,s,n,i){const a=e.href,o=e.title||null,r=t[1].replace(i.other.outputLinkReplace,"$1");n.state.inLink=!0;const c={type:t[0].charAt(0)==="!"?"image":"link",raw:s,href:a,title:o,text:r,tokens:n.inlineTokens(r)};return n.state.inLink=!1,c}function xs(t,e,s){const n=t.match(s.other.indentCodeCompensation);if(n===null)return e;const i=n[1];return e.split(`
`).map(a=>{const o=a.match(s.other.beginningSpace);if(o===null)return a;const[r]=o;return r.length>=i.length?a.slice(i.length):a}).join(`
`)}var ge=class{options;rules;lexer;constructor(t){this.options=t||N}space(t){const e=this.rules.block.newline.exec(t);if(e&&e[0].length>0)return{type:"space",raw:e[0]}}code(t){const e=this.rules.block.code.exec(t);if(e){const s=e[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:e[0],codeBlockStyle:"indented",text:this.options.pedantic?s:W(s,`
`)}}}fences(t){const e=this.rules.block.fences.exec(t);if(e){const s=e[0],n=xs(s,e[3]||"",this.rules);return{type:"code",raw:s,lang:e[2]?e[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):e[2],text:n}}}heading(t){const e=this.rules.block.heading.exec(t);if(e){let s=e[2].trim();if(this.rules.other.endingHash.test(s)){const n=W(s,"#");(this.options.pedantic||!n||this.rules.other.endingSpaceChar.test(n))&&(s=n.trim())}return{type:"heading",raw:e[0],depth:e[1].length,text:s,tokens:this.lexer.inline(s)}}}hr(t){const e=this.rules.block.hr.exec(t);if(e)return{type:"hr",raw:W(e[0],`
`)}}blockquote(t){const e=this.rules.block.blockquote.exec(t);if(e){let s=W(e[0],`
`).split(`
`),n="",i="";const a=[];for(;s.length>0;){let o=!1;const r=[];let c;for(c=0;c<s.length;c++)if(this.rules.other.blockquoteStart.test(s[c]))r.push(s[c]),o=!0;else if(!o)r.push(s[c]);else break;s=s.slice(c);const l=r.join(`
`),d=l.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");n=n?`${n}
${l}`:l,i=i?`${i}
${d}`:d;const u=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(d,a,!0),this.lexer.state.top=u,s.length===0)break;const h=a.at(-1);if(h?.type==="code")break;if(h?.type==="blockquote"){const g=h,p=g.raw+`
`+s.join(`
`),f=this.blockquote(p);a[a.length-1]=f,n=n.substring(0,n.length-g.raw.length)+f.raw,i=i.substring(0,i.length-g.text.length)+f.text;break}else if(h?.type==="list"){const g=h,p=g.raw+`
`+s.join(`
`),f=this.list(p);a[a.length-1]=f,n=n.substring(0,n.length-h.raw.length)+f.raw,i=i.substring(0,i.length-g.raw.length)+f.raw,s=p.substring(a.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:n,tokens:a,text:i}}}list(t){let e=this.rules.block.list.exec(t);if(e){let s=e[1].trim();const n=s.length>1,i={type:"list",raw:"",ordered:n,start:n?+s.slice(0,-1):"",loose:!1,items:[]};s=n?`\\d{1,9}\\${s.slice(-1)}`:`\\${s}`,this.options.pedantic&&(s=n?s:"[*+-]");const a=this.rules.other.listItemRegex(s);let o=!1;for(;t;){let c=!1,l="",d="";if(!(e=a.exec(t))||this.rules.block.hr.test(t))break;l=e[0],t=t.substring(l.length);let u=e[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,I=>" ".repeat(3*I.length)),h=t.split(`
`,1)[0],g=!u.trim(),p=0;if(this.options.pedantic?(p=2,d=u.trimStart()):g?p=e[1].length+1:(p=e[2].search(this.rules.other.nonSpaceChar),p=p>4?1:p,d=u.slice(p),p+=e[1].length),g&&this.rules.other.blankLine.test(h)&&(l+=h+`
`,t=t.substring(h.length+1),c=!0),!c){const I=this.rules.other.nextBulletRegex(p),ae=this.rules.other.hrRegex(p),G=this.rules.other.fencesBeginRegex(p),oe=this.rules.other.headingBeginRegex(p),Nt=this.rules.other.htmlBeginRegex(p);for(;t;){const ve=t.split(`
`,1)[0];let Z;if(h=ve,this.options.pedantic?(h=h.replace(this.rules.other.listReplaceNesting,"  "),Z=h):Z=h.replace(this.rules.other.tabCharGlobal,"    "),G.test(h)||oe.test(h)||Nt.test(h)||I.test(h)||ae.test(h))break;if(Z.search(this.rules.other.nonSpaceChar)>=p||!h.trim())d+=`
`+Z.slice(p);else{if(g||u.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||G.test(u)||oe.test(u)||ae.test(u))break;d+=`
`+h}!g&&!h.trim()&&(g=!0),l+=ve+`
`,t=t.substring(ve.length+1),u=Z.slice(p)}}i.loose||(o?i.loose=!0:this.rules.other.doubleBlankLine.test(l)&&(o=!0));let f=null,T;this.options.gfm&&(f=this.rules.other.listIsTask.exec(d),f&&(T=f[0]!=="[ ] ",d=d.replace(this.rules.other.listReplaceTask,""))),i.items.push({type:"list_item",raw:l,task:!!f,checked:T,loose:!1,text:d,tokens:[]}),i.raw+=l}const r=i.items.at(-1);if(r)r.raw=r.raw.trimEnd(),r.text=r.text.trimEnd();else return;i.raw=i.raw.trimEnd();for(let c=0;c<i.items.length;c++)if(this.lexer.state.top=!1,i.items[c].tokens=this.lexer.blockTokens(i.items[c].text,[]),!i.loose){const l=i.items[c].tokens.filter(u=>u.type==="space"),d=l.length>0&&l.some(u=>this.rules.other.anyLine.test(u.raw));i.loose=d}if(i.loose)for(let c=0;c<i.items.length;c++)i.items[c].loose=!0;return i}}html(t){const e=this.rules.block.html.exec(t);if(e)return{type:"html",block:!0,raw:e[0],pre:e[1]==="pre"||e[1]==="script"||e[1]==="style",text:e[0]}}def(t){const e=this.rules.block.def.exec(t);if(e){const s=e[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),n=e[2]?e[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",i=e[3]?e[3].substring(1,e[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):e[3];return{type:"def",tag:s,raw:e[0],href:n,title:i}}}table(t){const e=this.rules.block.table.exec(t);if(!e||!this.rules.other.tableDelimiter.test(e[2]))return;const s=st(e[1]),n=e[2].replace(this.rules.other.tableAlignChars,"").split("|"),i=e[3]?.trim()?e[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],a={type:"table",raw:e[0],header:[],align:[],rows:[]};if(s.length===n.length){for(const o of n)this.rules.other.tableAlignRight.test(o)?a.align.push("right"):this.rules.other.tableAlignCenter.test(o)?a.align.push("center"):this.rules.other.tableAlignLeft.test(o)?a.align.push("left"):a.align.push(null);for(let o=0;o<s.length;o++)a.header.push({text:s[o],tokens:this.lexer.inline(s[o]),header:!0,align:a.align[o]});for(const o of i)a.rows.push(st(o,a.header.length).map((r,c)=>({text:r,tokens:this.lexer.inline(r),header:!1,align:a.align[c]})));return a}}lheading(t){const e=this.rules.block.lheading.exec(t);if(e)return{type:"heading",raw:e[0],depth:e[2].charAt(0)==="="?1:2,text:e[1],tokens:this.lexer.inline(e[1])}}paragraph(t){const e=this.rules.block.paragraph.exec(t);if(e){const s=e[1].charAt(e[1].length-1)===`
`?e[1].slice(0,-1):e[1];return{type:"paragraph",raw:e[0],text:s,tokens:this.lexer.inline(s)}}}text(t){const e=this.rules.block.text.exec(t);if(e)return{type:"text",raw:e[0],text:e[0],tokens:this.lexer.inline(e[0])}}escape(t){const e=this.rules.inline.escape.exec(t);if(e)return{type:"escape",raw:e[0],text:e[1]}}tag(t){const e=this.rules.inline.tag.exec(t);if(e)return!this.lexer.state.inLink&&this.rules.other.startATag.test(e[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(e[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(e[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(e[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:e[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:e[0]}}link(t){const e=this.rules.inline.link.exec(t);if(e){const s=e[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(s)){if(!this.rules.other.endAngleBracket.test(s))return;const a=W(s.slice(0,-1),"\\");if((s.length-a.length)%2===0)return}else{const a=bs(e[2],"()");if(a===-2)return;if(a>-1){const r=(e[0].indexOf("!")===0?5:4)+e[1].length+a;e[2]=e[2].substring(0,a),e[0]=e[0].substring(0,r).trim(),e[3]=""}}let n=e[2],i="";if(this.options.pedantic){const a=this.rules.other.pedanticHrefTitle.exec(n);a&&(n=a[1],i=a[3])}else i=e[3]?e[3].slice(1,-1):"";return n=n.trim(),this.rules.other.startAngleBracket.test(n)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(s)?n=n.slice(1):n=n.slice(1,-1)),nt(e,{href:n&&n.replace(this.rules.inline.anyPunctuation,"$1"),title:i&&i.replace(this.rules.inline.anyPunctuation,"$1")},e[0],this.lexer,this.rules)}}reflink(t,e){let s;if((s=this.rules.inline.reflink.exec(t))||(s=this.rules.inline.nolink.exec(t))){const n=(s[2]||s[1]).replace(this.rules.other.multipleSpaceGlobal," "),i=e[n.toLowerCase()];if(!i){const a=s[0].charAt(0);return{type:"text",raw:a,text:a}}return nt(s,i,s[0],this.lexer,this.rules)}}emStrong(t,e,s=""){let n=this.rules.inline.emStrongLDelim.exec(t);if(!n||n[3]&&s.match(this.rules.other.unicodeAlphaNumeric))return;if(!(n[1]||n[2]||"")||!s||this.rules.inline.punctuation.exec(s)){const a=[...n[0]].length-1;let o,r,c=a,l=0;const d=n[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(d.lastIndex=0,e=e.slice(-1*t.length+a);(n=d.exec(e))!=null;){if(o=n[1]||n[2]||n[3]||n[4]||n[5]||n[6],!o)continue;if(r=[...o].length,n[3]||n[4]){c+=r;continue}else if((n[5]||n[6])&&a%3&&!((a+r)%3)){l+=r;continue}if(c-=r,c>0)continue;r=Math.min(r,r+c+l);const u=[...n[0]][0].length,h=t.slice(0,a+n.index+u+r);if(Math.min(a,r)%2){const p=h.slice(1,-1);return{type:"em",raw:h,text:p,tokens:this.lexer.inlineTokens(p)}}const g=h.slice(2,-2);return{type:"strong",raw:h,text:g,tokens:this.lexer.inlineTokens(g)}}}}codespan(t){const e=this.rules.inline.code.exec(t);if(e){let s=e[2].replace(this.rules.other.newLineCharGlobal," ");const n=this.rules.other.nonSpaceChar.test(s),i=this.rules.other.startingSpaceChar.test(s)&&this.rules.other.endingSpaceChar.test(s);return n&&i&&(s=s.substring(1,s.length-1)),{type:"codespan",raw:e[0],text:s}}}br(t){const e=this.rules.inline.br.exec(t);if(e)return{type:"br",raw:e[0]}}del(t){const e=this.rules.inline.del.exec(t);if(e)return{type:"del",raw:e[0],text:e[2],tokens:this.lexer.inlineTokens(e[2])}}autolink(t){const e=this.rules.inline.autolink.exec(t);if(e){let s,n;return e[2]==="@"?(s=e[1],n="mailto:"+s):(s=e[1],n=s),{type:"link",raw:e[0],text:s,href:n,tokens:[{type:"text",raw:s,text:s}]}}}url(t){let e;if(e=this.rules.inline.url.exec(t)){let s,n;if(e[2]==="@")s=e[0],n="mailto:"+s;else{let i;do i=e[0],e[0]=this.rules.inline._backpedal.exec(e[0])?.[0]??"";while(i!==e[0]);s=e[0],e[1]==="www."?n="http://"+e[0]:n=e[0]}return{type:"link",raw:e[0],text:s,href:n,tokens:[{type:"text",raw:s,text:s}]}}}inlineText(t){const e=this.rules.inline.text.exec(t);if(e){const s=this.lexer.state.inRawBlock;return{type:"text",raw:e[0],text:e[0],escaped:s}}}},D=class Ie{tokens;options;state;tokenizer;inlineQueue;constructor(e){this.tokens=[],this.tokens.links=Object.create(null),this.options=e||N,this.options.tokenizer=this.options.tokenizer||new ge,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};const s={other:x,block:re.normal,inline:J.normal};this.options.pedantic?(s.block=re.pedantic,s.inline=J.pedantic):this.options.gfm&&(s.block=re.gfm,this.options.breaks?s.inline=J.breaks:s.inline=J.gfm),this.tokenizer.rules=s}static get rules(){return{block:re,inline:J}}static lex(e,s){return new Ie(s).lex(e)}static lexInline(e,s){return new Ie(s).inlineTokens(e)}lex(e){e=e.replace(x.carriageReturn,`
`),this.blockTokens(e,this.tokens);for(let s=0;s<this.inlineQueue.length;s++){const n=this.inlineQueue[s];this.inlineTokens(n.src,n.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,s=[],n=!1){for(this.options.pedantic&&(e=e.replace(x.tabCharGlobal,"    ").replace(x.spaceLine,""));e;){let i;if(this.options.extensions?.block?.some(o=>(i=o.call({lexer:this},e,s))?(e=e.substring(i.raw.length),s.push(i),!0):!1))continue;if(i=this.tokenizer.space(e)){e=e.substring(i.raw.length);const o=s.at(-1);i.raw.length===1&&o!==void 0?o.raw+=`
`:s.push(i);continue}if(i=this.tokenizer.code(e)){e=e.substring(i.raw.length);const o=s.at(-1);o?.type==="paragraph"||o?.type==="text"?(o.raw+=`
`+i.raw,o.text+=`
`+i.text,this.inlineQueue.at(-1).src=o.text):s.push(i);continue}if(i=this.tokenizer.fences(e)){e=e.substring(i.raw.length),s.push(i);continue}if(i=this.tokenizer.heading(e)){e=e.substring(i.raw.length),s.push(i);continue}if(i=this.tokenizer.hr(e)){e=e.substring(i.raw.length),s.push(i);continue}if(i=this.tokenizer.blockquote(e)){e=e.substring(i.raw.length),s.push(i);continue}if(i=this.tokenizer.list(e)){e=e.substring(i.raw.length),s.push(i);continue}if(i=this.tokenizer.html(e)){e=e.substring(i.raw.length),s.push(i);continue}if(i=this.tokenizer.def(e)){e=e.substring(i.raw.length);const o=s.at(-1);o?.type==="paragraph"||o?.type==="text"?(o.raw+=`
`+i.raw,o.text+=`
`+i.raw,this.inlineQueue.at(-1).src=o.text):this.tokens.links[i.tag]||(this.tokens.links[i.tag]={href:i.href,title:i.title});continue}if(i=this.tokenizer.table(e)){e=e.substring(i.raw.length),s.push(i);continue}if(i=this.tokenizer.lheading(e)){e=e.substring(i.raw.length),s.push(i);continue}let a=e;if(this.options.extensions?.startBlock){let o=1/0;const r=e.slice(1);let c;this.options.extensions.startBlock.forEach(l=>{c=l.call({lexer:this},r),typeof c=="number"&&c>=0&&(o=Math.min(o,c))}),o<1/0&&o>=0&&(a=e.substring(0,o+1))}if(this.state.top&&(i=this.tokenizer.paragraph(a))){const o=s.at(-1);n&&o?.type==="paragraph"?(o.raw+=`
`+i.raw,o.text+=`
`+i.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=o.text):s.push(i),n=a.length!==e.length,e=e.substring(i.raw.length);continue}if(i=this.tokenizer.text(e)){e=e.substring(i.raw.length);const o=s.at(-1);o?.type==="text"?(o.raw+=`
`+i.raw,o.text+=`
`+i.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=o.text):s.push(i);continue}if(e){const o="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(o);break}else throw new Error(o)}}return this.state.top=!0,s}inline(e,s=[]){return this.inlineQueue.push({src:e,tokens:s}),s}inlineTokens(e,s=[]){let n=e,i=null;if(this.tokens.links){const r=Object.keys(this.tokens.links);if(r.length>0)for(;(i=this.tokenizer.rules.inline.reflinkSearch.exec(n))!=null;)r.includes(i[0].slice(i[0].lastIndexOf("[")+1,-1))&&(n=n.slice(0,i.index)+"["+"a".repeat(i[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(i=this.tokenizer.rules.inline.anyPunctuation.exec(n))!=null;)n=n.slice(0,i.index)+"++"+n.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);for(;(i=this.tokenizer.rules.inline.blockSkip.exec(n))!=null;)n=n.slice(0,i.index)+"["+"a".repeat(i[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);let a=!1,o="";for(;e;){a||(o=""),a=!1;let r;if(this.options.extensions?.inline?.some(l=>(r=l.call({lexer:this},e,s))?(e=e.substring(r.raw.length),s.push(r),!0):!1))continue;if(r=this.tokenizer.escape(e)){e=e.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.tag(e)){e=e.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.link(e)){e=e.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(r.raw.length);const l=s.at(-1);r.type==="text"&&l?.type==="text"?(l.raw+=r.raw,l.text+=r.text):s.push(r);continue}if(r=this.tokenizer.emStrong(e,n,o)){e=e.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.codespan(e)){e=e.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.br(e)){e=e.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.del(e)){e=e.substring(r.raw.length),s.push(r);continue}if(r=this.tokenizer.autolink(e)){e=e.substring(r.raw.length),s.push(r);continue}if(!this.state.inLink&&(r=this.tokenizer.url(e))){e=e.substring(r.raw.length),s.push(r);continue}let c=e;if(this.options.extensions?.startInline){let l=1/0;const d=e.slice(1);let u;this.options.extensions.startInline.forEach(h=>{u=h.call({lexer:this},d),typeof u=="number"&&u>=0&&(l=Math.min(l,u))}),l<1/0&&l>=0&&(c=e.substring(0,l+1))}if(r=this.tokenizer.inlineText(c)){e=e.substring(r.raw.length),r.raw.slice(-1)!=="_"&&(o=r.raw.slice(-1)),a=!0;const l=s.at(-1);l?.type==="text"?(l.raw+=r.raw,l.text+=r.text):s.push(r);continue}if(e){const l="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(l);break}else throw new Error(l)}}return s}},fe=class{options;parser;constructor(t){this.options=t||N}space(t){return""}code({text:t,lang:e,escaped:s}){const n=(e||"").match(x.notSpaceStart)?.[0],i=t.replace(x.endingNewline,"")+`
`;return n?'<pre><code class="language-'+$(n)+'">'+(s?i:$(i,!0))+`</code></pre>
`:"<pre><code>"+(s?i:$(i,!0))+`</code></pre>
`}blockquote({tokens:t}){return`<blockquote>
${this.parser.parse(t)}</blockquote>
`}html({text:t}){return t}heading({tokens:t,depth:e}){return`<h${e}>${this.parser.parseInline(t)}</h${e}>
`}hr(t){return`<hr>
`}list(t){const e=t.ordered,s=t.start;let n="";for(let o=0;o<t.items.length;o++){const r=t.items[o];n+=this.listitem(r)}const i=e?"ol":"ul",a=e&&s!==1?' start="'+s+'"':"";return"<"+i+a+`>
`+n+"</"+i+`>
`}listitem(t){let e="";if(t.task){const s=this.checkbox({checked:!!t.checked});t.loose?t.tokens[0]?.type==="paragraph"?(t.tokens[0].text=s+" "+t.tokens[0].text,t.tokens[0].tokens&&t.tokens[0].tokens.length>0&&t.tokens[0].tokens[0].type==="text"&&(t.tokens[0].tokens[0].text=s+" "+$(t.tokens[0].tokens[0].text),t.tokens[0].tokens[0].escaped=!0)):t.tokens.unshift({type:"text",raw:s+" ",text:s+" ",escaped:!0}):e+=s+" "}return e+=this.parser.parse(t.tokens,!!t.loose),`<li>${e}</li>
`}checkbox({checked:t}){return"<input "+(t?'checked="" ':"")+'disabled="" type="checkbox">'}paragraph({tokens:t}){return`<p>${this.parser.parseInline(t)}</p>
`}table(t){let e="",s="";for(let i=0;i<t.header.length;i++)s+=this.tablecell(t.header[i]);e+=this.tablerow({text:s});let n="";for(let i=0;i<t.rows.length;i++){const a=t.rows[i];s="";for(let o=0;o<a.length;o++)s+=this.tablecell(a[o]);n+=this.tablerow({text:s})}return n&&(n=`<tbody>${n}</tbody>`),`<table>
<thead>
`+e+`</thead>
`+n+`</table>
`}tablerow({text:t}){return`<tr>
${t}</tr>
`}tablecell(t){const e=this.parser.parseInline(t.tokens),s=t.header?"th":"td";return(t.align?`<${s} align="${t.align}">`:`<${s}>`)+e+`</${s}>
`}strong({tokens:t}){return`<strong>${this.parser.parseInline(t)}</strong>`}em({tokens:t}){return`<em>${this.parser.parseInline(t)}</em>`}codespan({text:t}){return`<code>${$(t,!0)}</code>`}br(t){return"<br>"}del({tokens:t}){return`<del>${this.parser.parseInline(t)}</del>`}link({href:t,title:e,tokens:s}){const n=this.parser.parseInline(s),i=tt(t);if(i===null)return n;t=i;let a='<a href="'+t+'"';return e&&(a+=' title="'+$(e)+'"'),a+=">"+n+"</a>",a}image({href:t,title:e,text:s,tokens:n}){n&&(s=this.parser.parseInline(n,this.parser.textRenderer));const i=tt(t);if(i===null)return $(s);t=i;let a=`<img src="${t}" alt="${s}"`;return e&&(a+=` title="${$(e)}"`),a+=">",a}text(t){return"tokens"in t&&t.tokens?this.parser.parseInline(t.tokens):"escaped"in t&&t.escaped?t.text:$(t.text)}},Oe=class{strong({text:t}){return t}em({text:t}){return t}codespan({text:t}){return t}del({text:t}){return t}html({text:t}){return t}text({text:t}){return t}link({text:t}){return""+t}image({text:t}){return""+t}br(){return""}},M=class Ae{options;renderer;textRenderer;constructor(e){this.options=e||N,this.options.renderer=this.options.renderer||new fe,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new Oe}static parse(e,s){return new Ae(s).parse(e)}static parseInline(e,s){return new Ae(s).parseInline(e)}parse(e,s=!0){let n="";for(let i=0;i<e.length;i++){const a=e[i];if(this.options.extensions?.renderers?.[a.type]){const r=a,c=this.options.extensions.renderers[r.type].call({parser:this},r);if(c!==!1||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(r.type)){n+=c||"";continue}}const o=a;switch(o.type){case"space":{n+=this.renderer.space(o);continue}case"hr":{n+=this.renderer.hr(o);continue}case"heading":{n+=this.renderer.heading(o);continue}case"code":{n+=this.renderer.code(o);continue}case"table":{n+=this.renderer.table(o);continue}case"blockquote":{n+=this.renderer.blockquote(o);continue}case"list":{n+=this.renderer.list(o);continue}case"html":{n+=this.renderer.html(o);continue}case"paragraph":{n+=this.renderer.paragraph(o);continue}case"text":{let r=o,c=this.renderer.text(r);for(;i+1<e.length&&e[i+1].type==="text";)r=e[++i],c+=`
`+this.renderer.text(r);s?n+=this.renderer.paragraph({type:"paragraph",raw:c,text:c,tokens:[{type:"text",raw:c,text:c,escaped:!0}]}):n+=c;continue}default:{const r='Token with "'+o.type+'" type was not found.';if(this.options.silent)return console.error(r),"";throw new Error(r)}}}return n}parseInline(e,s=this.renderer){let n="";for(let i=0;i<e.length;i++){const a=e[i];if(this.options.extensions?.renderers?.[a.type]){const r=this.options.extensions.renderers[a.type].call({parser:this},a);if(r!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(a.type)){n+=r||"";continue}}const o=a;switch(o.type){case"escape":{n+=s.text(o);break}case"html":{n+=s.html(o);break}case"link":{n+=s.link(o);break}case"image":{n+=s.image(o);break}case"strong":{n+=s.strong(o);break}case"em":{n+=s.em(o);break}case"codespan":{n+=s.codespan(o);break}case"br":{n+=s.br(o);break}case"del":{n+=s.del(o);break}case"text":{n+=s.text(o);break}default:{const r='Token with "'+o.type+'" type was not found.';if(this.options.silent)return console.error(r),"";throw new Error(r)}}}return n}},ce=class{options;block;constructor(t){this.options=t||N}static passThroughHooks=new Set(["preprocess","postprocess","processAllTokens"]);preprocess(t){return t}postprocess(t){return t}processAllTokens(t){return t}provideLexer(){return this.block?D.lex:D.lexInline}provideParser(){return this.block?M.parse:M.parseInline}},Ss=class{defaults=Re();options=this.setOptions;parse=this.parseMarkdown(!0);parseInline=this.parseMarkdown(!1);Parser=M;Renderer=fe;TextRenderer=Oe;Lexer=D;Tokenizer=ge;Hooks=ce;constructor(...t){this.use(...t)}walkTokens(t,e){let s=[];for(const n of t)switch(s=s.concat(e.call(this,n)),n.type){case"table":{const i=n;for(const a of i.header)s=s.concat(this.walkTokens(a.tokens,e));for(const a of i.rows)for(const o of a)s=s.concat(this.walkTokens(o.tokens,e));break}case"list":{const i=n;s=s.concat(this.walkTokens(i.items,e));break}default:{const i=n;this.defaults.extensions?.childTokens?.[i.type]?this.defaults.extensions.childTokens[i.type].forEach(a=>{const o=i[a].flat(1/0);s=s.concat(this.walkTokens(o,e))}):i.tokens&&(s=s.concat(this.walkTokens(i.tokens,e)))}}return s}use(...t){const e=this.defaults.extensions||{renderers:{},childTokens:{}};return t.forEach(s=>{const n={...s};if(n.async=this.defaults.async||n.async||!1,s.extensions&&(s.extensions.forEach(i=>{if(!i.name)throw new Error("extension name required");if("renderer"in i){const a=e.renderers[i.name];a?e.renderers[i.name]=function(...o){let r=i.renderer.apply(this,o);return r===!1&&(r=a.apply(this,o)),r}:e.renderers[i.name]=i.renderer}if("tokenizer"in i){if(!i.level||i.level!=="block"&&i.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");const a=e[i.level];a?a.unshift(i.tokenizer):e[i.level]=[i.tokenizer],i.start&&(i.level==="block"?e.startBlock?e.startBlock.push(i.start):e.startBlock=[i.start]:i.level==="inline"&&(e.startInline?e.startInline.push(i.start):e.startInline=[i.start]))}"childTokens"in i&&i.childTokens&&(e.childTokens[i.name]=i.childTokens)}),n.extensions=e),s.renderer){const i=this.defaults.renderer||new fe(this.defaults);for(const a in s.renderer){if(!(a in i))throw new Error(`renderer '${a}' does not exist`);if(["options","parser"].includes(a))continue;const o=a,r=s.renderer[o],c=i[o];i[o]=(...l)=>{let d=r.apply(i,l);return d===!1&&(d=c.apply(i,l)),d||""}}n.renderer=i}if(s.tokenizer){const i=this.defaults.tokenizer||new ge(this.defaults);for(const a in s.tokenizer){if(!(a in i))throw new Error(`tokenizer '${a}' does not exist`);if(["options","rules","lexer"].includes(a))continue;const o=a,r=s.tokenizer[o],c=i[o];i[o]=(...l)=>{let d=r.apply(i,l);return d===!1&&(d=c.apply(i,l)),d}}n.tokenizer=i}if(s.hooks){const i=this.defaults.hooks||new ce;for(const a in s.hooks){if(!(a in i))throw new Error(`hook '${a}' does not exist`);if(["options","block"].includes(a))continue;const o=a,r=s.hooks[o],c=i[o];ce.passThroughHooks.has(a)?i[o]=l=>{if(this.defaults.async)return Promise.resolve(r.call(i,l)).then(u=>c.call(i,u));const d=r.call(i,l);return c.call(i,d)}:i[o]=(...l)=>{let d=r.apply(i,l);return d===!1&&(d=c.apply(i,l)),d}}n.hooks=i}if(s.walkTokens){const i=this.defaults.walkTokens,a=s.walkTokens;n.walkTokens=function(o){let r=[];return r.push(a.call(this,o)),i&&(r=r.concat(i.call(this,o))),r}}this.defaults={...this.defaults,...n}}),this}setOptions(t){return this.defaults={...this.defaults,...t},this}lexer(t,e){return D.lex(t,e??this.defaults)}parser(t,e){return M.parse(t,e??this.defaults)}parseMarkdown(t){return(s,n)=>{const i={...n},a={...this.defaults,...i},o=this.onError(!!a.silent,!!a.async);if(this.defaults.async===!0&&i.async===!1)return o(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof s>"u"||s===null)return o(new Error("marked(): input parameter is undefined or null"));if(typeof s!="string")return o(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(s)+", string expected"));a.hooks&&(a.hooks.options=a,a.hooks.block=t);const r=a.hooks?a.hooks.provideLexer():t?D.lex:D.lexInline,c=a.hooks?a.hooks.provideParser():t?M.parse:M.parseInline;if(a.async)return Promise.resolve(a.hooks?a.hooks.preprocess(s):s).then(l=>r(l,a)).then(l=>a.hooks?a.hooks.processAllTokens(l):l).then(l=>a.walkTokens?Promise.all(this.walkTokens(l,a.walkTokens)).then(()=>l):l).then(l=>c(l,a)).then(l=>a.hooks?a.hooks.postprocess(l):l).catch(o);try{a.hooks&&(s=a.hooks.preprocess(s));let l=r(s,a);a.hooks&&(l=a.hooks.processAllTokens(l)),a.walkTokens&&this.walkTokens(l,a.walkTokens);let d=c(l,a);return a.hooks&&(d=a.hooks.postprocess(d)),d}catch(l){return o(l)}}}onError(t,e){return s=>{if(s.message+=`
Please report this to https://github.com/markedjs/marked.`,t){const n="<p>An error occurred:</p><pre>"+$(s.message+"",!0)+"</pre>";return e?Promise.resolve(n):n}if(e)return Promise.reject(s);throw s}}},B=new Ss;function k(t,e){return B.parse(t,e)}k.options=k.setOptions=function(t){return B.setOptions(t),k.defaults=B.defaults,dt(k.defaults),k};k.getDefaults=Re;k.defaults=N;k.use=function(...t){return B.use(...t),k.defaults=B.defaults,dt(k.defaults),k};k.walkTokens=function(t,e){return B.walkTokens(t,e)};k.parseInline=B.parseInline;k.Parser=M;k.parser=M.parse;k.Renderer=fe;k.TextRenderer=Oe;k.Lexer=D;k.lexer=D.lex;k.Tokenizer=ge;k.Hooks=ce;k.parse=k;k.options;k.setOptions;k.use;k.walkTokens;k.parseInline;M.parse;D.lex;const vs=new Map;function Es(t,e){const s=new Proxy(e,{set(n,i,a){const o=globalThis.Alpine?.store(t);return o?o[i]=a:n[i]=a,!0},get(n,i){return n[i]}});return globalThis.Alpine?globalThis.Alpine.store(t,e):document.addEventListener("alpine:init",()=>Alpine.store(t,e)),vs.set(t,s),s}let de;{const t=document.createElement("style");t.appendChild(document.createTextNode("")),document.head.appendChild(t),de=t.sheet}function H(t,e,s){const n=document.styleSheets;for(let o=0;o<n.length;o++){const r=n[o];let c;try{c=r.cssRules||r.rules}catch{continue}if(c)for(let l=0;l<c.length;l++){const d=c[l];if(d.selectorText==t){it(d,e,s);return}}}const i=de.insertRule(`${t} {}`,de.cssRules.length),a=de.cssRules[i];it(a,e,s)}function it(t,e,s){s===void 0?t.style.removeProperty(e):t.style.setProperty(e,s)}const Cs={settings:{},async init(){this.settings=JSON.parse(localStorage.getItem("messageResizeSettings")||"null")||this._getDefaultSettings(),this._applyAllSettings()},_getDefaultSettings(){return{message:{minimized:!1,maximized:!1},"message-agent":{minimized:!0,maximized:!1},"message-agent-response":{minimized:!1,maximized:!0}}},getSetting(t){return this.settings[t]||{minimized:!1,maximized:!1}},_getDefaultSetting(){return{minimized:!1,maximized:!1}},_setSetting(t,e){this.settings[t]=e,localStorage.setItem("messageResizeSettings",JSON.stringify(this.settings))},_applyAllSettings(){for(const[t,e]of Object.entries(this.settings))this._applySetting(t,e)},async minimizeMessageClass(t,e){const s=this.getSetting(t);s.minimized=!s.minimized,this._setSetting(t,s),this._applySetting(t,s),this._applyScroll(e)},async maximizeMessageClass(t,e){const s=this.getSetting(t);if(s.minimized)return this.minimizeMessageClass(t,e);s.maximized=!s.maximized,this._setSetting(t,s),this._applySetting(t,s),this._applyScroll(e)},_applyScroll(t){if(!t||!t.target)return;const e=t.target,s=t.clientY;try{const n=e.getBoundingClientRect(),i=window.innerHeight||document.documentElement.clientHeight,a=document.getElementById("chat-history");if(!a)return;const o=a.getBoundingClientRect(),r=n.height,l=n.top+r/2-o.top;let d;if(typeof s=="number"){const u=s-o.top;d=a.scrollTop+l-u}else{const u=a.clientHeight*.5;d=a.scrollTop+l-u}a.scrollTo({top:d,behavior:"auto"})}catch{}},_applySetting(t,e){H(`.${t} .message-body`,"max-height",e.maximized?"unset":"30em"),H(`.${t} .message-body`,"overflow-y",e.maximized?"unset":"auto"),H(`.${t} .message-body`,"display",e.minimized?"none":"block")}};Es("messageResize",Cs);const Is=document.getElementById("chat-history");let P=null;function As(t,e,s,n,i,a=null){let o=document.getElementById(`message-${t}`);if(o){if(e==="user")return;o.innerHTML=""}else{const c=e==="user"?"user":"ai";o=document.createElement("div"),o.id=`message-${t}`,o.classList.add("message-container",`${c}-container`)}if($s(e)(o,t,e,s,n,i,a),!document.getElementById(`message-${t}`)){const c={user:"right",info:"mid",warning:"mid",error:"mid",rate_limit:"mid",util:"mid",hint:"mid"},l={agent:!0},d=c[e]||"left";(!P||l[e]||d!=P.getAttribute("data-group-type"))&&(P=document.createElement("div"),P.id=`message-group-${t}`,P.classList.add("message-group",`message-group-${d}`),P.setAttribute("data-group-type",d)),P.appendChild(o),Is.appendChild(P)}}function Ls(){const t=document.createElement("button");return t.className="copy-button",t.textContent="Copy",t.addEventListener("click",async function(e){e.stopPropagation();const s=this.closest(".msg-content, .kvps-row, .message-text");let n;s.classList.contains("kvps-row")?n=s.querySelector(".kvps-val").innerText:(s.classList.contains("message-text"),n=s.querySelector("span").innerText);try{await navigator.clipboard.writeText(n);const i=t.textContent;t.classList.add("copied"),t.textContent="Copied!",setTimeout(()=>{t.classList.remove("copied"),t.textContent=i},2e3)}catch(i){console.error("Failed to copy text:",i)}}),t}function me(t){t.querySelector(".copy-button")||t.appendChild(Ls())}function $s(t){switch(t){case"user":return Ms;case"agent":return Rs;case"response":return Ds;case"tool":return Ps;case"code_exe":return zs;case"browser":return Fs;case"warning":return ot;case"rate_limit":return ot;case"error":return Ns;case"info":return at;case"util":return Bs;case"hint":return at;default:return _s}}function z(t,e,s,n,i,a="",o=null,r=[],c=[],l=!1,d=!1,u=!0){const h=document.createElement("div");if(h.classList.add("message",a,...r),e){const p=document.createElement("div");p.classList.add("msg-heading");const f=document.createElement("h4");if(f.innerHTML=St(He(e)),p.appendChild(f),h.appendChild(p),u){const T=document.createElement("div");T.classList.add("msg-min-max-btns"),T.innerHTML=`
        <a href="#" class="msg-min-max-btn" @click.prevent="$store.messageResize.minimizeMessageClass('${a}', $event)"><span class="material-symbols-outlined" x-text="$store.messageResize.getSetting('${a}').minimized ? 'expand_content' : 'minimize'"></span></a>
        <a href="#" class="msg-min-max-btn" x-show="!$store.messageResize.getSetting('${a}').minimized" @click.prevent="$store.messageResize.maximizeMessageClass('${a}', $event)"><span class="material-symbols-outlined" x-text="$store.messageResize.getSetting('${a}').maximized ? 'expand' : 'expand_all'"></span></a>
      `,p.appendChild(T)}}const g=document.createElement("div");if(g.classList.add("message-body"),h.appendChild(g),Os(g,o,!1),s&&s.trim().length>0)if(d){const p=document.createElement("div");p.classList.add("msg-content",...c);const f=document.createElement("span");let T=s;T=bt(T),T=js(T),T=k.parse(T,{breaks:!0}),T=vt(T),f.innerHTML=T,l&&f.querySelectorAll("latex").forEach(I=>{katex.render(I.innerHTML,I,{throwOnError:!1})}),p.appendChild(f),me(p),Hs(p),g.appendChild(p)}else{const p=document.createElement("pre");p.classList.add("msg-content",...c),p.style.whiteSpace="pre-wrap",p.style.wordBreak="break-word";const f=document.createElement("span");f.innerHTML=xt(s),f.addEventListener("click",()=>{je(f.textContent,f)}),p.appendChild(f),me(p),g.appendChild(p)}return t.appendChild(h),i&&t.classList.add("message-followup"),setTimeout(()=>{g.scrollTop=g.scrollHeight},0),h}function _s(t,e,s,n,i,a,o=null){z(t,n,i,a,!1,"message-default",o,["message-ai"],["msg-json"],!1,!1)}function Rs(t,e,s,n,i,a,o=null){let r=null;o&&(r={...o,...o.tool_args||{}},delete r.tool_args),z(t,n,i,a,!1,"message-agent",r,["message-ai"],["msg-json"],!1,!1)}function Ds(t,e,s,n,i,a,o=null){z(t,n,i,a,!0,"message-agent-response",null,["message-ai"],[],!0,!0)}function Ms(t,e,s,n,i,a,o=null,r=!1){const c=document.createElement("div");c.classList.add("message","message-user");const l=document.createElement("h4");if(l.classList.add("msg-heading"),l.innerHTML="User message <span class='icon material-symbols-outlined'>person</span>",c.appendChild(l),i&&i.trim().length>0){const d=document.createElement("div");d.classList.add("message-text");const u=document.createElement("pre");u.innerHTML=He(i),d.appendChild(u),d.addEventListener("click",()=>{je(i,d)}),me(d),c.appendChild(d)}if(o&&o.attachments&&o.attachments.length>0){const d=document.createElement("div");d.classList.add("attachments-container"),o.attachments.forEach(u=>{const h=document.createElement("div");if(h.classList.add("attachment-item"),typeof u=="string"){const g=u,p=g.split(".").pop().toUpperCase();h.classList.add("file-type"),h.innerHTML=`
                    <div class="file-preview">
                        <span class="filename">${g}</span>
                        <span class="extension">${p}</span>
                    </div>
                `}else if(u.type==="image"){const g=document.createElement("div");g.classList.add("image-wrapper");const p=document.createElement("img");p.src=u.url,p.alt=u.name,p.classList.add("attachment-preview");const f=document.createElement("div");f.classList.add("file-info"),f.innerHTML=`
                    <span class="filename">${u.name}</span>
                    <span class="extension">${u.extension.toUpperCase()}</span>
                `,g.appendChild(p),h.appendChild(g),h.appendChild(f)}else h.classList.add("file-type"),h.innerHTML=`
                    <div class="file-preview">
                        <span class="filename">${u.name}</span>
                        <span class="extension">${u.extension.toUpperCase()}</span>
                    </div>
                `;d.appendChild(h)}),c.appendChild(d)}t.appendChild(c)}function Ps(t,e,s,n,i,a,o=null){z(t,n,i,a,!0,"message-tool",o,["message-ai"],["msg-output"],!1,!1)}function zs(t,e,s,n,i,a,o=null){z(t,n,i,a,!0,"message-code-exe",null,["message-ai"],[],!1,!1)}function Fs(t,e,s,n,i,a,o=null){z(t,n,i,a,!0,"message-browser",o,["message-ai"],["msg-json"],!1,!1)}function qe(t,e,s,n,i,a,o,r=null){z(e,i,a,o,!1,t,r,[],[],!1,!1),e.classList.add("center-container")}function at(t,e,s,n,i,a,o=null){return qe("message-info",t,e,s,n,i,a,o)}function Bs(t,e,s,n,i,a,o=null){z(t,n,i,a,!1,"message-util",o,[],["msg-json"],!1,!1),t.classList.add("center-container")}function ot(t,e,s,n,i,a,o=null){return qe("message-warning",t,e,s,n,i,a,o)}function Ns(t,e,s,n,i,a,o=null){return qe("message-error",t,e,s,n,i,a,o)}function Os(t,e,s){if(e){const n=document.createElement("table");n.classList.add("msg-kvps");for(let[i,a]of Object.entries(e)){let d=function(u){if(typeof u=="object"&&(u=JSON.stringify(u,null,2)),typeof u=="string"&&u.startsWith("img://")){const h=document.createElement("img");h.classList.add("kvps-img"),h.src=u.replace("img://","/image_get?path="),h.alt="Image Attachment",l.appendChild(h),h.style.cursor="pointer",h.addEventListener("click",()=>{qt(h.src,1e3)})}else{const h=document.createElement("pre"),g=document.createElement("span");g.innerHTML=xt(u),h.appendChild(g),l.appendChild(h),me(o),g.addEventListener("click",()=>{je(g.textContent,g)}),s&&g.querySelectorAll("latex").forEach(p=>{katex.render(p.innerHTML,p,{throwOnError:!1})})}};const o=n.insertRow();o.classList.add("kvps-row"),(i==="thoughts"||i==="reasoning")&&o.classList.add("msg-thoughts");const r=o.insertCell();r.textContent=qs(i),r.classList.add("kvps-key");const c=o.insertCell(),l=document.createElement("div");if(l.classList.add("kvps-val"),c.appendChild(l),Array.isArray(a))for(const u of a)d(u);else d(a);setTimeout(()=>{l.scrollTop=l.scrollHeight},0)}t.appendChild(n)}}function qs(t){return t.replace(/_/g," ").toLowerCase().replace(/\b\w/g,function(e){return e.toUpperCase()})}function bt(t){const e=/<image>(.*?)<\/image>/g;return t.replace(e,(n,i)=>`<img src="data:image/jpeg;base64,${i}" alt="Image Attachment" style="max-width: 250px !important;"/>`)}async function je(t,e){try{await navigator.clipboard.writeText(t),e.classList.add("copied"),setTimeout(()=>{e.classList.remove("copied")},2e3)}catch(s){console.error("Failed to copy text:",s)}}function xt(t){typeof t!="string"&&(t=JSON.stringify(t,null,2));let e=He(t);return e=bt(e),e=vt(e),e}function js(t){return t.replace("img://","/image_get?path=")}function St(t){return t.replace(/icon:\/\/([a-zA-Z0-9_]+)/g,'<span class="icon material-symbols-outlined">$1</span>')}function He(t){const e={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"};return t.replace(/[&<>'"]/g,s=>e[s])}function vt(t){function e(c){const l=c.split("/");l[0]||l.shift();let d="",u="";for(const h of l)d+="/"+h,u+=`/<a href="#" class="path-link" onclick="openFileLink('${d}');">${h}</a>`;return u}const s="(?:^|[> `'\"\\n]|&#39;|&quot;)",n="[a-zA-Z0-9_\\/.\\-]",i="[a-zA-Z0-9_\\-\\/]",a="(?<!\\.)",o=new RegExp(`(?<=${s})\\/${n}*${i}${a}`,"g"),r=/(<(?:[^<>"']+|"[^"]*"|'[^']*')*>)/g;return t.split(r).map(c=>c.startsWith("<")?c:c.replace(o,e)).join("")}function Hs(t){t.querySelectorAll("table, code").forEach(s=>{const n=document.createElement("div");n.className="message-markdown-table-wrap",s.parentNode.insertBefore(n,s),n.appendChild(s)})}const ue=document.getElementById("microphone-button");let R=null,Ee=!1;const y={INACTIVE:"inactive",ACTIVATING:"activating",LISTENING:"listening",RECORDING:"recording",WAITING:"waiting",PROCESSING:"processing"},Q={stt_model_size:"tiny",stt_language:"en",stt_silence_threshold:.05,stt_silence_duration:1e3,stt_waiting_timeout:2e3};window.micSettings=Q;Et();function Us(t){return Math.exp(-5*(1-t))}async function Et(){try{const s=(await(await fetchApi("/settings_get",{method:"POST"})).json()).settings.sections.find(n=>n.title==="Speech to Text");s&&s.fields.forEach(n=>{const i=n.id;Q[i]=n.value})}catch(t){window.toastFetchError("Failed to load speech settings",t),console.error("Failed to load speech settings:",t)}}class Gs{constructor(e,s={}){this.mediaRecorder=null,this.audioChunks=[],this.lastChunk=[],this.updateCallback=e,this.messageSent=!1,this.audioContext=null,this.mediaStreamSource=null,this.analyserNode=null,this._status=y.INACTIVE,this.lastAudioTime=null,this.waitingTimer=null,this.silenceStartTime=null,this.hasStartedRecording=!1,this.analysisFrame=null}get status(){return this._status}set status(e){if(this._status===e)return;const s=this._status;this._status=e,console.log(`Mic status changed from ${s} to ${e}`),ue.classList.remove(`mic-${s.toLowerCase()}`),ue.classList.add(`mic-${e.toLowerCase()}`),ue.setAttribute("data-status",e),this.handleStatusChange(s,e)}handleStatusChange(e,s){switch(s!=y.RECORDING&&(this.lastChunk=null),s){case y.INACTIVE:this.handleInactiveState();break;case y.LISTENING:this.handleListeningState();break;case y.RECORDING:this.handleRecordingState();break;case y.WAITING:this.handleWaitingState();break;case y.PROCESSING:this.handleProcessingState();break}}handleInactiveState(){this.stopRecording(),this.stopAudioAnalysis(),this.waitingTimer&&(clearTimeout(this.waitingTimer),this.waitingTimer=null)}handleListeningState(){this.stopRecording(),this.audioChunks=[],this.hasStartedRecording=!1,this.silenceStartTime=null,this.lastAudioTime=null,this.messageSent=!1,this.startAudioAnalysis()}handleRecordingState(){!this.hasStartedRecording&&this.mediaRecorder.state!=="recording"&&(this.hasStartedRecording=!0,this.mediaRecorder.start(1e3),console.log("Speech started")),this.waitingTimer&&(clearTimeout(this.waitingTimer),this.waitingTimer=null)}handleWaitingState(){this.waitingTimer=setTimeout(()=>{this.status===y.WAITING&&(this.status=y.PROCESSING)},Q.stt_waiting_timeout)}handleProcessingState(){this.stopRecording(),this.process()}stopRecording(){this.mediaRecorder?.state==="recording"&&(this.mediaRecorder.stop(),this.hasStartedRecording=!1)}async initialize(){try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,channelCount:1}});return this.mediaRecorder=new MediaRecorder(e),this.mediaRecorder.ondataavailable=s=>{s.data.size>0&&(this.status===y.RECORDING||this.status===y.WAITING)?(this.lastChunk&&(this.audioChunks.push(this.lastChunk),this.lastChunk=null),this.audioChunks.push(s.data),console.log("Audio chunk received, total chunks:",this.audioChunks.length)):this.status===y.LISTENING&&(this.lastChunk=s.data)},this.setupAudioAnalysis(e),!0}catch(e){return console.error("Microphone initialization error:",e),toast("Failed to access microphone. Please check permissions.","error"),!1}}setupAudioAnalysis(e){this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.mediaStreamSource=this.audioContext.createMediaStreamSource(e),this.analyserNode=this.audioContext.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.minDecibels=-90,this.analyserNode.maxDecibels=-10,this.analyserNode.smoothingTimeConstant=.85,this.mediaStreamSource.connect(this.analyserNode)}startAudioAnalysis(){const e=()=>{if(this.status===y.INACTIVE)return;const s=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(s);let n=0;for(let o=0;o<s.length;o++){const r=(s[o]-128)/128;n+=r*r}const i=Math.sqrt(n/s.length),a=Date.now();i>Us(Q.stt_silence_threshold)?(this.lastAudioTime=a,this.silenceStartTime=null,(this.status===y.LISTENING||this.status===y.WAITING)&&(be.isSpeaking()||(this.status=y.RECORDING))):this.status===y.RECORDING&&(this.silenceStartTime||(this.silenceStartTime=a),a-this.silenceStartTime>=Q.stt_silence_duration&&(this.status=y.WAITING)),this.analysisFrame=requestAnimationFrame(e)};this.analysisFrame=requestAnimationFrame(e)}stopAudioAnalysis(){this.analysisFrame&&(cancelAnimationFrame(this.analysisFrame),this.analysisFrame=null)}async process(){if(this.audioChunks.length===0){this.status=y.LISTENING;return}const e=new Blob(this.audioChunks,{type:"audio/wav"}),s=await this.convertBlobToBase64Wav(e);try{const n=await sendJsonData("/transcribe",{audio:s});this.filterResult(n.text||"")&&(console.log("Transcription:",n.text),await this.updateCallback(n.text,!0))}catch(n){window.toastFetchError("Transcription error",n),console.error("Transcription error:",n)}finally{this.audioChunks=[],this.status=y.LISTENING}}convertBlobToBase64Wav(e){return new Promise((s,n)=>{const i=new FileReader;i.onloadend=()=>{const a=i.result.split(",")[1];s(a)},i.onerror=a=>{n(a)},i.readAsDataURL(e)})}filterResult(e){e=e.trim();let s=!1;for(;!s&&!(!e||e[0]==="{"&&e[e.length-1]==="}"||e[0]==="("&&e[e.length-1]===")"||e[0]==="["&&e[e.length-1]==="]");)s=!0;if(s)return e;console.log(`Discarding transcription: ${e}`)}}async function Zs(){return window.microphoneInput=R=new Gs(async(t,e)=>{e&&(tn(t),R.messageSent||(R.messageSent=!0,await Ge()))}),R.status=y.ACTIVATING,await R.initialize()}ue.addEventListener("click",async()=>{if(!(Ee||(Ee=!0,!await Js())))try{if(!R&&!await Zs())return;R.status=R.status===y.INACTIVE||R.status===y.ACTIVATING?y.LISTENING:y.INACTIVE}finally{setTimeout(()=>{Ee=!1},300)}});async function Js(){try{return await navigator.mediaDevices.getUserMedia({audio:!0}),!0}catch(t){return console.error("Error accessing microphone:",t),toast("Microphone access denied. Please enable microphone access in your browser settings.","error"),!1}}class Ws{constructor(){this.synth=window.speechSynthesis,this.utterance=null}stripEmojis(e){return e.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g,"").replace(/\s+/g," ").trim()}speak(e){console.log("Speaking:",e),this.stop(),e=this.stripEmojis(e),e=this.replaceURLs(e),e=this.replaceGuids(e),this.utterance=new SpeechSynthesisUtterance(e),this.synth.speak(this.utterance)}replaceURLs(e){const s=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\b(www\.)[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\b[-A-Z0-9+&@#\/%?=~_|!:,.;]*\.(?:[A-Z]{2,})[-A-Z0-9+&@#\/%?=~_|])/gi;return e.replace(s,n=>{let i=n;if(i.includes("://")&&(i=i.split("://")[1]),i.includes("/")&&(i=i.split("/")[0]),i.includes(".")){const a=i.split(".");return a[a.length-2]+"."+a[a.length-1]}else return i})}replaceGuids(e){const s=/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/g;return e.replace(s,"")}replaceNonText(e){const s=/\w[^\w\s]*\w(?=\s|$)|[^\w\s]+/g;e=e.replace(s,i=>"");const n=/\S{25,}/g;return e=e.replace(n,i=>""),e}stop(){this.isSpeaking()&&this.synth.cancel()}isSpeaking(){return this.synth?.speaking||!1}}const be=new Ws;window.speech=be;document.addEventListener("settings-updated",Et);async function Vs(t,e){const s=await Y(t,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(e)});if(!s.ok){const i=await s.text();throw new Error(i)}return await s.json()}async function Y(t,e){async function s(i){const a=await Qs(),o=e||{};o.headers=o.headers||{},o.headers["X-CSRF-Token"]=a;const r=await fetch(t,o);return r.status===403&&i?(q=null,await s(!1)):r}return await s(!0)}let q=null;async function Qs(){if(q)return q;const t=await fetch("/csrf_token",{credentials:"same-origin"}).then(e=>e.json());return q=t.token,document.cookie=`csrf_token_${t.runtime_id}=${q}; SameSite=Strict; Path=/`,q}window.fetchApi=Y;const K=document.getElementById("left-panel"),ke=document.getElementById("right-panel");document.querySelector(".container");const A=document.getElementById("chat-input"),X=document.getElementById("chat-history"),Ks=document.getElementById("send-button"),Ue=document.getElementById("input-section");document.getElementById("status-section");const ne=document.getElementById("chats-section"),Ys=document.getElementById("tasks-section"),le=document.getElementById("progress-bar"),Xs=document.getElementById("auto-scroll-switch"),en=document.getElementById("time-date-container");let Ct=!0,w="",It=!1;xe();Ve();function At(){return window.innerWidth<=768}function Lt(t){const e=document.getElementById("sidebar-overlay");typeof t=="boolean"?(K.classList.toggle("hidden",!t),ke.classList.toggle("expanded",!t),e.classList.toggle("visible",t)):(K.classList.toggle("hidden"),ke.classList.toggle("expanded"),e.classList.toggle("visible",!K.classList.contains("hidden")))}function $t(){const t=document.getElementById("sidebar-overlay");At()?(K.classList.add("hidden"),ke.classList.add("expanded"),t.classList.remove("visible")):(K.classList.remove("hidden"),ke.classList.remove("expanded"),t.classList.remove("visible"))}window.addEventListener("load",$t);window.addEventListener("resize",$t);document.addEventListener("DOMContentLoaded",()=>{document.getElementById("sidebar-overlay").addEventListener("click",()=>{At()&&Lt(!1)})});function xe(){document.getElementById("left-panel"),document.getElementById("right-panel");const t=document.getElementById("toggle-sidebar");t?t.addEventListener("click",Lt):(console.error("Toggle sidebar button not found"),setTimeout(xe,100))}document.addEventListener("DOMContentLoaded",xe);async function Ge(){try{const t=A.value.trim(),e=Alpine.$data(Ue),s=e.attachments,n=s&&s.length>0;if(t||n){let i;const a=Je();if(n){const r=s.map(l=>l.type==="image"?{...l,url:URL.createObjectURL(l.file)}:{...l});Rt(a,"user","",t,!1,{attachments:r});const c=new FormData;c.append("text",t),c.append("context",w),c.append("message_id",a);for(let l=0;l<s.length;l++)c.append("attachments",s[l].file);i=await Y("/message_async",{method:"POST",body:c})}else i=await Y("/message_async",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t,context:w,message_id:a})});const o=await i.json();o?C(o.context):S("No response returned.","error"),A.value="",e.attachments=[],e.hasAttachments=!1,Ze()}}catch(t){U("Error sending message",t)}}function U(t,e){Dt()?S(`${t}: ${e.message}`,"error"):S(`${t} (it seems the backend is not running): ${e.message}`,"error"),console.error(t,e)}window.toastFetchError=U;A.addEventListener("keydown",t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),Ge())});Ks.addEventListener("click",Ge);function tn(t){console.log("updateChatInput called with:",t);const e=A.value,s=e.length>0&&!e.endsWith(" ");A.value=e+(s?" ":"")+t+" ",Ze(),A.dispatchEvent(new Event("input")),console.log("Updated chat input value:",A.value)}function _t(){const t=new Date,e=t.getHours(),s=t.getMinutes(),n=t.getSeconds(),i=e>=12?"pm":"am",o=`${e%12||12}:${s.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")} ${i}`,r={year:"numeric",month:"short",day:"numeric"},c=t.toLocaleDateString(void 0,r),l=document.getElementById("time-date");l.innerHTML=`${o}<br><span id="user-date">${c}</span>`}_t();setInterval(_t,1e3);function Rt(t,e,s,n,i,a=null){const o=As(t,e,s,n,i,a);return Ct&&(X.scrollTop=X.scrollHeight),o}window.loadKnowledge=async function(){const t=document.createElement("input");t.type="file",t.accept=".txt,.pdf,.csv,.html,.json,.md",t.multiple=!0,t.onchange=async()=>{try{const e=new FormData;for(let n of t.files)e.append("files[]",n);e.append("ctxid",Se());const s=await Y("/import_knowledge",{method:"POST",body:e});if(!s.ok)S(await s.text(),"error");else{const n=await s.json();S("Knowledge files imported: "+n.filenames.join(", "),"success")}}catch(e){U("Error loading knowledge",e)}},t.click()};function Ze(){A.style.height="auto",A.style.height=A.scrollHeight+"px"}const _=async function(t,e){return await Vs(t,e)};window.sendJsonData=_;function Je(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=Math.random()*16|0,s=t==="x"?e:e&3|8;return s.toString(16)})}function Dt(){return It}function rt(t){It=t;const e=Alpine.$data(en.querySelector(".status-icon"));e.connected=t}let j=0,he="",Le=0;async function We(){let t=!1;try{const e=Intl.DateTimeFormat().resolvedOptions().timeZone,s=await _("/poll",{log_from:j,context:w||null,timezone:e});if(!s)return console.error("Invalid response from poll endpoint"),!1;if(w||C(s.context),s.context!=w)return;if(he!=s.log_guid&&(X.innerHTML="",j=0),j!=s.log_version){t=!0;for(const r of s.logs){const c=r.id||r.no;Rt(c,r.type,r.heading,r.content,r.temp,r.kvps)}sn(s.logs)}j=s.log_version,he=s.log_guid,an(s.log_progress,s.log_progress_active);const n=Alpine.$data(Ue);n.paused=s.paused,rt(!0);const i=Alpine.$data(ne),a=s.contexts||[];i.contexts=a.sort((r,c)=>(c.created_at||0)-(r.created_at||0));const o=document.getElementById("tasks-section");if(o){const r=Alpine.$data(o);let c=s.tasks||[];if(c.length>0){const l=[...c].sort((d,u)=>(u.created_at||0)-(d.created_at||0));r.tasks=l}else r.tasks=[]}if(w){const r=localStorage.getItem("activeTab")||"chats";if(r==="chats"){if(i.selected=w,localStorage.setItem("lastSelectedChat",w),!a.some(l=>l.id===w)&&a.length>0){const l=a[0].id;C(l),i.selected=l,localStorage.setItem("lastSelectedChat",l)}}else if(r==="tasks"&&o){const c=Alpine.$data(o);if(c.selected=w,localStorage.setItem("lastSelectedTask",w),!s.tasks?.some(d=>d.id===w)&&s.tasks?.length>0){const d=s.tasks[0].id;C(d),c.selected=d,localStorage.setItem("lastSelectedTask",d)}}}else if(s.tasks&&s.tasks.length>0&&localStorage.getItem("activeTab")==="tasks"){const r=s.tasks[0].id;if(C(r),o){const c=Alpine.$data(o);c.selected=r,localStorage.setItem("lastSelectedTask",r)}}else if(a.length>0&&localStorage.getItem("activeTab")==="chats"){const r=a[0].id;w||(C(r),i.selected=r,localStorage.setItem("lastSelectedChat",r))}j=s.log_version,he=s.log_guid}catch(e){console.error("Error:",e),rt(!1)}return t}function sn(t){localStorage.getItem("speech")=="true"&&nn(t)}function nn(t){for(let e=t.length-1;e>=0;e--){const s=t[e];if(s.type=="response"&&s.no>Le){Le=s.no,be.speak(s.content);return}}}function an(t,e){t||(t=""),e?cn(le,"shiny-text"):dn(le,"shiny-text"),t=St(t),le.innerHTML!=t&&(le.innerHTML=t)}window.pauseAgent=async function(t){try{const e=await _("/pause",{paused:t,context:w})}catch(e){window.toastFetchError("Error pausing agent",e)}};window.resetChat=async function(t=null){try{const e=await _("/chat_reset",{context:t===null?w:t});t===null&&ie()}catch(e){window.toastFetchError("Error resetting chat",e)}};window.newChat=async function(){try{C(Je()),ie()}catch(t){window.toastFetchError("Error creating new chat",t)}};window.killChat=async function(t){if(!t){console.error("No chat ID provided for deletion");return}console.log("Deleting chat with ID:",t);try{const e=Alpine.$data(ne);console.log("Current contexts before deletion:",JSON.stringify(e.contexts.map(n=>({id:n.id,name:n.name})))),Mt(t),await _("/chat_remove",{context:t});const s=e.contexts.filter(n=>n.id!==t);console.log("Updated contexts after deletion:",JSON.stringify(s.map(n=>({id:n.id,name:n.name})))),e.contexts=[...s],ie(),S("Chat deleted successfully","success")}catch(e){console.error("Error deleting chat:",e),window.toastFetchError("Error deleting chat",e)}};function Mt(t){if(w===t){const e=Alpine.$data(ne);let s=null;for(let n=0;n<e.contexts.length;n++)if(e.contexts[n].id!==t){s=e.contexts[n];break}C(s?s.id:Je())}}function on(t){const e=localStorage.getItem("activeTab")||"chats",s=document.getElementById("tasks-section");let n=!1;if(s){const i=Alpine.$data(s);i&&i.tasks&&(n=i.tasks.some(a=>a.id===t))}return n&&e==="chats"?(localStorage.setItem("lastSelectedTask",t),ee("tasks"),!0):!n&&e==="tasks"?(localStorage.setItem("lastSelectedChat",t),ee("chats"),!0):!1}window.selectChat=async function(t){if(t===w)return;if(!on(t)){C(t);const s=Alpine.$data(ne),n=document.getElementById("tasks-section");if(n){const a=Alpine.$data(n);a.selected=t}s.selected=t;const i=localStorage.getItem("activeTab")||"chats";i==="chats"?localStorage.setItem("lastSelectedChat",t):i==="tasks"&&localStorage.setItem("lastSelectedTask",t),We()}ie()};const C=function(t){if(t==w)return;w=t,he="",j=0,Le=0,X.innerHTML="";const e=Alpine.$data(ne),s=Alpine.$data(Ys);e.selected=t,s.selected=t},Se=function(){return w};window.toggleAutoScroll=async function(t){Ct=t};window.toggleJson=async function(t){H(".msg-json","display",t?"block":"none")};window.toggleThoughts=async function(t){H(".msg-thoughts","display",t?void 0:"none")};window.toggleUtils=async function(t){H(".message-util","display",t?void 0:"none")};window.toggleDarkMode=function(t){t?(document.body.classList.remove("light-mode"),document.body.classList.add("dark-mode")):(document.body.classList.remove("dark-mode"),document.body.classList.add("light-mode")),console.log("Dark mode:",t),localStorage.setItem("darkMode",t)};window.toggleSpeech=function(t){console.log("Speech:",t),localStorage.setItem("speech",t),t||be.stop()};window.nudge=async function(){try{const t=await _("/nudge",{ctxid:Se()})}catch(t){U("Error nudging agent",t)}};window.restart=async function(){try{if(!Dt()){S("Backend disconnected, cannot restart.","error");return}const t=await _("/restart",{})}catch{S("Restarting...","info",0);let e=0;const s=240;for(;e<s;)try{const n=await _("/health",{});await new Promise(i=>setTimeout(i,250)),ye(),await new Promise(i=>setTimeout(i,400)),S("Restarted","success",5e3);return}catch{e++,await new Promise(i=>setTimeout(i,250))}ye(),await new Promise(n=>setTimeout(n,400)),S("Restart timed out or failed","error",5e3)}};document.addEventListener("DOMContentLoaded",()=>{const t=localStorage.getItem("darkMode")!=="false";toggleDarkMode(t)});window.loadChats=async function(){try{const t=await ln(),e=await _("/chat_load",{chats:t});e?(C(e.ctxids[0]),S("Chats loaded.","success")):S("No response returned.","error")}catch(t){U("Error loading chats",t)}};window.saveChat=async function(){try{const t=await _("/chat_export",{ctxid:w});t?(rn(t.ctxid+".json",t.content),S("Chat file downloaded.","success")):S("No response returned.","error")}catch(t){U("Error saving chat",t)}};function rn(t,e){const s=new Blob([e],{type:"application/json"}),n=document.createElement("a"),i=URL.createObjectURL(s);n.href=i,n.download=t,n.click(),setTimeout(()=>{URL.revokeObjectURL(i)},0)}function ln(){return new Promise((t,e)=>{const s=document.createElement("input");s.type="file",s.accept=".json",s.multiple=!0,s.click(),s.onchange=async()=>{const n=s.files;if(!n.length){t([]);return}const i=Array.from(n).map(a=>new Promise((o,r)=>{const c=new FileReader;c.onload=()=>o(c.result),c.onerror=r,c.readAsText(a)}));try{const a=await Promise.all(i);t(a)}catch(a){e(a)}}})}function cn(t,e){t.classList.add(e)}function dn(t,e){t.classList.remove(e)}function S(t,e="info",s=5e3){const n=document.getElementById("toast"),i=n.classList.contains("show");n.timeoutId&&(clearTimeout(n.timeoutId),n.timeoutId=null);const a=()=>{const o=e.charAt(0).toUpperCase()+e.slice(1);n.querySelector(".toast__title").textContent=o,n.querySelector(".toast__message").textContent=t,n.classList.remove("toast--success","toast--error","toast--info"),n.classList.add(`toast--${e}`);const r=n.querySelector(".toast__copy");r.style.display=e==="error"?"inline-block":"none";const c=document.querySelector(".toast__close");if(c.onclick=()=>{ye()},r.onclick=()=>{navigator.clipboard.writeText(t),r.textContent="Copied!",setTimeout(()=>{r.textContent="Copy"},2e3)},n.style.display="flex",n.offsetWidth,n.classList.add("show"),s){const l=Math.max(s,5e3);n.timeoutId=setTimeout(()=>{ye()},l)}};i?(n.classList.remove("show"),n.classList.add("hide"),setTimeout(()=>{n.classList.remove("hide"),a()},400)):a()}window.toast=S;function ye(){const t=document.getElementById("toast");t.timeoutId&&(clearTimeout(t.timeoutId),t.timeoutId=null),t.classList.remove("show"),t.classList.add("hide"),setTimeout(()=>{t.style.display="none",t.classList.remove("hide")},400)}function un(t){const e=Alpine.$data(Xs);e.autoScroll=t}function ie(){const e=document.getElementById("chat-history"),s=e.scrollHeight-e.scrollTop<=e.clientHeight+50;un(s)}X.addEventListener("scroll",ie);A.addEventListener("input",Ze);async function hn(){let n=0;async function i(){let a=250;try{await We()&&(n=100),n>0&&n--,a=n>0?25:250}catch(o){console.error("Error:",o)}setTimeout(i.bind(this),a)}i()}document.addEventListener("DOMContentLoaded",hn);document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("dragdrop-overlay"),e=document.getElementById("input-section");let s=0;["dragenter","dragover","dragleave","drop"].forEach(n=>{document.addEventListener(n,i=>{i.preventDefault(),i.stopPropagation()},!1)}),document.addEventListener("dragenter",n=>{s++,s===1&&(Alpine.$data(t).isVisible=!0)},!1),document.addEventListener("dragleave",n=>{s--,s===0&&(Alpine.$data(t).isVisible=!1)},!1),t.addEventListener("drop",n=>{s=0,Alpine.$data(t).isVisible=!1;const i=Alpine.$data(e),a=n.dataTransfer.files;Pt(a,i)},!1)});function Pt(t,e){Array.from(t).forEach(s=>{const n=s.name.split(".").pop().toLowerCase();if(["jpg","jpeg","png","bmp"].includes(n)){const a=new FileReader;a.onload=o=>{e.attachments.push({file:s,url:o.target.result,type:"image",name:s.name,extension:n}),e.hasAttachments=!0},a.readAsDataURL(s)}else e.attachments.push({file:s,type:"file",name:s.name,extension:n}),e.hasAttachments=!0})}window.handleFileUpload=function(t){const e=t.target.files,s=Alpine.$data(Ue);Pt(e,s)};document.addEventListener("DOMContentLoaded",function(){xe(),Ve(),pn()});function Ve(){const t=document.getElementById("chats-tab"),e=document.getElementById("tasks-tab");t&&e?(t.addEventListener("click",function(){ee("chats")}),e.addEventListener("click",function(){ee("tasks")})):(console.error("Tab elements not found"),setTimeout(Ve,100))}function ee(t){const e=document.getElementById("chats-tab"),s=document.getElementById("tasks-tab"),n=document.getElementById("chats-section"),i=document.getElementById("tasks-section"),a=w,o=localStorage.getItem("activeTab");if(o==="chats"?localStorage.setItem("lastSelectedChat",a):o==="tasks"&&localStorage.setItem("lastSelectedTask",a),e.classList.remove("active"),s.classList.remove("active"),n.style.display="none",i.style.display="none",localStorage.setItem("activeTab",t),t==="chats"){e.classList.add("active"),n.style.display="";const c=Alpine.$data(n).contexts||[],l=localStorage.getItem("lastSelectedChat");l&&l!==a&&(c.some(d=>d.id===l)||c.length===0)&&C(l)}else if(t==="tasks"){s.classList.add("active"),i.style.display="flex",i.style.flexDirection="column";const c=Alpine.$data(i).tasks||[],l=localStorage.getItem("lastSelectedTask");l&&l!==a&&c.some(d=>d.id===l)&&C(l)}We()}function pn(){localStorage.getItem("lastSelectedChat")||localStorage.setItem("lastSelectedChat",""),localStorage.getItem("lastSelectedTask")||localStorage.setItem("lastSelectedTask","");const t=localStorage.getItem("activeTab")||"chats";ee(t)}function gn(t){if(window.Alpine){const e=document.getElementById("settings");if(e){e.click();const s=document.getElementById("settingsModal");if(!s){console.error("Settings modal element not found after clicking button");return}const n=Alpine.$data(s);setTimeout(()=>{n.switchTab("scheduler"),setTimeout(()=>{const i=document.querySelector('[x-data="schedulerSettings"]');if(!i){console.error("Scheduler component not found");return}Alpine.$data(i).showTaskDetail(t),console.log("Task detail view opened for task:",t)},50)},25)}else console.error("Settings button not found")}else console.error("Alpine.js not loaded")}window.openTaskDetail=gn;const E=function(t,e="info"){typeof window.toast=="function"?window.toast(t,e):console.log(`Toast (${e}): ${t}`)},lt=function(){return{tasks:[],isLoading:!0,selectedTask:null,expandedTaskId:null,sortField:"name",sortDirection:"asc",filterType:"all",filterState:"all",pollingInterval:null,pollingActive:!1,editingTask:{name:"",type:"scheduled",state:"idle",schedule:{minute:"*",hour:"*",day:"*",month:"*",weekday:"*",timezone:v()},token:"",plan:{todo:[],in_progress:null,done:[]},system_prompt:"",prompt:"",attachments:[]},isCreating:!1,isEditing:!1,showLoadingState:!1,viewMode:"list",selectedTaskForDetail:null,attachmentsText:"",filteredTasks:[],hasNoTasks:!0,init(){this.tasks=[],this.isLoading=!0,this.hasNoTasks=!0,this.filterType="all",this.filterState="all",this.sortField="name",this.sortDirection="asc",this.pollingInterval=null,this.pollingActive=!1,this.startPolling(),this.fetchTasks(),document.addEventListener("click",t=>{const e=t.target.closest(".settings-tab");e&&e.getAttribute("data-tab")==="scheduler"&&setTimeout(()=>{this.fetchTasks()},100)}),this.$watch("tasks",t=>{this.updateTasksUI()}),this.$watch("filterType",()=>{this.updateTasksUI()}),this.$watch("filterState",()=>{this.updateTasksUI()}),this.viewMode=localStorage.getItem("scheduler_view_mode")||"list",this.selectedTask=null,this.expandedTaskId=null,this.editingTask={name:"",type:"scheduled",state:"idle",schedule:{minute:"*",hour:"*",day:"*",month:"*",weekday:"*",timezone:v()},token:this.generateRandomToken?this.generateRandomToken():"",plan:{todo:[],in_progress:null,done:[]},system_prompt:"",prompt:"",attachments:[]},this.$nextTick(()=>{setTimeout(()=>{this.isCreating?this.initFlatpickr("create"):this.isEditing&&this.initFlatpickr("edit")},100)}),this.$cleanup=()=>{console.log("Cleaning up schedulerSettings component"),this.stopPolling();const t=document.getElementById("newPlannedTime-create");t&&t._flatpickr&&t._flatpickr.destroy();const e=document.getElementById("newPlannedTime-edit");e&&e._flatpickr&&e._flatpickr.destroy()}},startPolling(){if(this.pollingInterval){console.log("Polling already active, not starting again");return}console.log("Starting task polling"),this.pollingActive=!0,this.fetchTasks(),this.pollingInterval=setInterval(()=>{this.pollingActive&&this.fetchTasks()},2e3)},stopPolling(){console.log("Stopping task polling"),this.pollingActive=!1,this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null)},async fetchTasks(){if(!(!this.pollingActive&&this.pollingInterval)&&!(this.isCreating||this.isEditing)){this.isLoading=!0;try{const t=await fetchApi("/scheduler_tasks_list",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({timezone:v()})});if(!t.ok)throw new Error("Failed to fetch tasks");const e=await t.json();if(!e||!e.tasks)console.error("Invalid response: data.tasks is missing",e),this.tasks=[];else if(!Array.isArray(e.tasks))console.error("Invalid response: data.tasks is not an array",e.tasks),this.tasks=[];else{const s=e.tasks.filter(n=>!n||typeof n!="object"?(console.error("Invalid task (not an object):",n),!1):n.uuid?n.name?n.type?!0:(console.error("Task missing type:",n),!1):(console.error("Task missing name:",n),!1):(console.error("Task missing uuid:",n),!1));s.length!==e.tasks.length&&console.warn(`Filtered out ${e.tasks.length-s.length} invalid tasks`),this.tasks=s,this.updateTasksUI()}}catch(t){console.error("Error fetching tasks:",t),this.pollingInterval||E("Failed to fetch tasks: "+t.message,"error"),this.tasks=[]}finally{this.isLoading=!1}}},changeSort(t){this.sortField===t?this.sortDirection=this.sortDirection==="asc"?"desc":"asc":(this.sortField=t,this.sortDirection="asc")},toggleTaskExpand(t){this.expandedTaskId===t?this.expandedTaskId=null:this.expandedTaskId=t},showTaskDetail(t){const e=this.tasks.find(s=>s.uuid===t);if(!e){E("Task not found","error");return}this.selectedTaskForDetail=JSON.parse(JSON.stringify(e)),this.selectedTaskForDetail.attachments||(this.selectedTaskForDetail.attachments=[]),this.viewMode="detail"},closeTaskDetail(){this.selectedTaskForDetail=null,this.viewMode="list"},formatDate(t){return t?Ye(t,"full"):"Never"},formatPlan(t){if(!t||!t.plan)return"No plan";const e=Array.isArray(t.plan.todo)?t.plan.todo.length:0,s=t.plan.in_progress?"Yes":"No",n=Array.isArray(t.plan.done)?t.plan.done.length:0;let i="";if(Array.isArray(t.plan.todo)&&t.plan.todo.length>0)try{const a=new Date(t.plan.todo[0]);isNaN(a.getTime())?(i="Invalid date",console.warn(`Invalid date format in plan.todo[0]: ${t.plan.todo[0]}`)):i=Ye(a,"short")}catch(a){console.error(`Error formatting next run time: ${a.message}`),i="Error"}else i="None";return`Next: ${i}
Todo: ${e}
In Progress: ${s}
Done: ${n}`},formatSchedule(t){if(!t.schedule)return"None";let e="";return typeof t.schedule=="string"?e=t.schedule:typeof t.schedule=="object"&&(e=`${t.schedule.minute||"*"} ${t.schedule.hour||"*"} ${t.schedule.day||"*"} ${t.schedule.month||"*"} ${t.schedule.weekday||"*"}`),e},getStateBadgeClass(t){switch(t){case"idle":return"scheduler-status-idle";case"running":return"scheduler-status-running";case"disabled":return"scheduler-status-disabled";case"error":return"scheduler-status-error";default:return""}},startCreateTask(){this.isCreating=!0,this.isEditing=!1,document.querySelector('[x-data="schedulerSettings"]')?.setAttribute("data-editing-state","creating"),this.editingTask={name:"",type:"scheduled",state:"idle",schedule:{minute:"*",hour:"*",day:"*",month:"*",weekday:"*",timezone:v()},token:this.generateRandomToken(),plan:{todo:[],in_progress:null,done:[]},system_prompt:"",prompt:"",attachments:[]},this.$nextTick(()=>{this.initFlatpickr("create")})},async startEditTask(t){const e=this.tasks.find(s=>s.uuid===t);if(!e){E("Task not found","error");return}if(this.isCreating=!1,this.isEditing=!0,document.querySelector('[x-data="schedulerSettings"]')?.setAttribute("data-editing-state","editing"),this.editingTask=JSON.parse(JSON.stringify(e)),console.log("Task data for editing:",e),console.log("Attachments from task:",e.attachments),this.editingTask.state||(this.editingTask.state="idle"),!this.editingTask.schedule||typeof this.editingTask.schedule=="string"){let s={minute:"*",hour:"*",day:"*",month:"*",weekday:"*",timezone:v()};if(typeof this.editingTask.schedule=="string"){const n=this.editingTask.schedule.split(" ");n.length>=5&&(s.minute=n[0]||"*",s.hour=n[1]||"*",s.day=n[2]||"*",s.month=n[3]||"*",s.weekday=n[4]||"*")}this.editingTask.schedule=s}else this.editingTask.schedule.timezone||(this.editingTask.schedule.timezone=v());this.editingTask.attachments?typeof this.editingTask.attachments=="string"?this.editingTask.attachments=this.editingTask.attachments.split(`
`).map(s=>s.trim()).filter(s=>s.length>0):Array.isArray(this.editingTask.attachments)||(this.editingTask.attachments=[]):this.editingTask.attachments=[],this.editingTask.type==="scheduled"?(this.editingTask.token||(this.editingTask.token=""),this.editingTask.plan||(this.editingTask.plan={todo:[],in_progress:null,done:[]})):this.editingTask.type==="adhoc"?(this.editingTask.token||(this.editingTask.token=this.generateRandomToken(),console.log("Generated new token for adhoc task:",this.editingTask.token)),console.log("Setting token for adhoc task:",this.editingTask.token),this.editingTask.plan||(this.editingTask.plan={todo:[],in_progress:null,done:[]})):this.editingTask.type==="planned"&&(this.editingTask.plan||(this.editingTask.plan={todo:[],in_progress:null,done:[]}),Array.isArray(this.editingTask.plan.todo)||(this.editingTask.plan.todo=[]),this.editingTask.token||(this.editingTask.token="")),this.$nextTick(()=>{this.initFlatpickr("edit")})},cancelEdit(){const t=e=>{const s=document.getElementById(e);if(s&&s._flatpickr){console.log(`Destroying Flatpickr instance for ${e}`),s._flatpickr.destroy();const n=s.closest(".scheduler-flatpickr-wrapper");n&&n.parentNode&&(n.parentNode.insertBefore(s,n),n.parentNode.removeChild(n)),s.classList.remove("scheduler-flatpickr-input")}};this.isCreating?t("newPlannedTime-create"):this.isEditing&&t("newPlannedTime-edit"),this.editingTask={name:"",type:"scheduled",state:"idle",schedule:{minute:"*",hour:"*",day:"*",month:"*",weekday:"*",timezone:v()},token:"",plan:{todo:[],in_progress:null,done:[]},system_prompt:"",prompt:"",attachments:[]},this.isCreating=!1,this.isEditing=!1,document.querySelector('[x-data="schedulerSettings"]')?.removeAttribute("data-editing-state")},async saveTask(){if(!this.editingTask.name.trim()||!this.editingTask.prompt.trim()){alert("Task name and prompt are required");return}try{let t,e;if(e={name:this.editingTask.name,system_prompt:this.editingTask.system_prompt||"",prompt:this.editingTask.prompt||"",state:this.editingTask.state||"idle",timezone:v()},e.attachments=Array.isArray(this.editingTask.attachments)?this.editingTask.attachments.map(a=>typeof a=="string"?a.trim():a).filter(a=>a&&a.trim().length>0):[],this.editingTask.type==="scheduled"){if(typeof this.editingTask.schedule=="string"){const a=this.editingTask.schedule.split(" ");e.schedule={minute:a[0]||"*",hour:a[1]||"*",day:a[2]||"*",month:a[3]||"*",weekday:a[4]||"*",timezone:v()}}else e.schedule={...this.editingTask.schedule,timezone:this.editingTask.schedule.timezone||v()};delete e.token,delete e.plan}else if(this.editingTask.type==="adhoc")this.editingTask.token||(this.editingTask.token=this.generateRandomToken(),console.log("Generated new token for adhoc task:",this.editingTask.token)),console.log("Setting token in taskData:",this.editingTask.token),e.token=this.editingTask.token,delete e.schedule,delete e.plan;else if(this.editingTask.type==="planned"){this.editingTask.plan||(this.editingTask.plan={todo:[],in_progress:null,done:[]}),Array.isArray(this.editingTask.plan.todo)||(this.editingTask.plan.todo=[]),Array.isArray(this.editingTask.plan.done)||(this.editingTask.plan.done=[]);const a=[];for(const o of this.editingTask.plan.todo)try{const r=new Date(o);isNaN(r.getTime())?console.warn(`Skipping invalid date in todo list: ${o}`):a.push(r.toISOString())}catch(r){console.warn(`Error processing date: ${r.message}`)}this.editingTask.plan.todo=a,this.editingTask.plan.todo.sort(),e.plan={todo:this.editingTask.plan.todo,in_progress:this.editingTask.plan.in_progress,done:this.editingTask.plan.done||[]},console.log("Planned task plan data:",JSON.stringify(e.plan,null,2)),delete e.schedule,delete e.token}this.isCreating?t="/scheduler_task_create":(t="/scheduler_task_update",e.task_id=this.editingTask.uuid),console.log("Final task data being sent to API:",JSON.stringify(e,null,2));const s=await fetchApi(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok){const a=await s.json();throw new Error(a.error||"Failed to save task")}const n=await s.json();E(this.isCreating?"Task created successfully":"Task updated successfully","success"),n&&n.task?(console.log("Task received in response:",n.task),this.isCreating?this.tasks=[...this.tasks,n.task]:this.tasks=this.tasks.map(a=>a.uuid===n.task.uuid?n.task:a),this.updateTasksUI()):await this.fetchTasks();const i=a=>{const o=document.getElementById(a);o&&o._flatpickr&&o._flatpickr.destroy()};this.isCreating?i("newPlannedTime-create"):this.isEditing&&i("newPlannedTime-edit"),this.editingTask={name:"",type:"scheduled",state:"idle",schedule:{minute:"*",hour:"*",day:"*",month:"*",weekday:"*",timezone:v()},token:"",plan:{todo:[],in_progress:null,done:[]},system_prompt:"",prompt:"",attachments:[]},this.isCreating=!1,this.isEditing=!1,document.querySelector('[x-data="schedulerSettings"]')?.removeAttribute("data-editing-state")}catch(t){console.error("Error saving task:",t),E("Failed to save task: "+t.message,"error")}},async runTask(t){try{const e=await fetchApi("/scheduler_task_run",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({task_id:t,timezone:v()})});if(!e.ok){const s=await e.json();throw new Error(s.error||"Failed to run task")}E("Task started successfully","success"),this.fetchTasks()}catch(e){console.error("Error running task:",e),E("Failed to run task: "+e.message,"error")}},async resetTaskState(t){try{const e=this.tasks.find(n=>n.uuid===t);if(!e){E("Task not found","error");return}if(e.state==="idle"){E("Task is already in idle state","info");return}this.showLoadingState=!0;const s=await fetchApi("/scheduler_task_update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({task_id:t,state:"idle",timezone:v()})});if(!s.ok){const n=await s.json();throw new Error(n.error||"Failed to reset task state")}E("Task state reset to idle","success"),await this.fetchTasks(),this.showLoadingState=!1}catch(e){console.error("Error resetting task state:",e),E("Failed to reset task state: "+e.message,"error"),this.showLoadingState=!1}},async deleteTask(t){if(confirm("Are you sure you want to delete this task? This action cannot be undone."))try{Mt(t);const e=await fetchApi("/scheduler_task_delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({task_id:t,timezone:v()})});if(!e.ok){const s=await e.json();throw new Error(s.error||"Failed to delete task")}E("Task deleted successfully","success"),this.selectedTaskForDetail&&this.selectedTaskForDetail.uuid===t&&this.closeTaskDetail(),this.tasks=this.tasks.filter(s=>s.uuid!==t),this.updateTasksUI()}catch(e){console.error("Error deleting task:",e),E("Failed to delete task: "+e.message,"error")}},initDateTimeInput(t){if(!t.target.value){const e=new Date;e.setMinutes(e.getMinutes()+30);const s=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),a=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0");t.target.value=`${s}-${n}-${i}T${a}:${o}`,t.target._flatpickr&&t.target._flatpickr.setDate(t.target.value)}},generateRandomToken(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let e="";for(let s=0;s<16;s++)e+=t.charAt(Math.floor(Math.random()*t.length));return e},get filteredTasks(){if(!Array.isArray(this.tasks))return console.warn("Tasks is not an array:",this.tasks),[];let t=[...this.tasks];return this.filterType&&this.filterType!=="all"&&(t=t.filter(e=>e.type?String(e.type).toLowerCase()===this.filterType.toLowerCase():!1)),this.filterState&&this.filterState!=="all"&&(t=t.filter(e=>e.state?String(e.state).toLowerCase()===this.filterState.toLowerCase():!1)),this.sortTasks(t)},sortTasks(t){return!Array.isArray(t)||t.length===0?t:[...t].sort((e,s)=>{if(!this.sortField)return 0;const n=e[this.sortField],i=s[this.sortField];if(n===void 0&&i===void 0)return 0;if(n===void 0)return 1;if(i===void 0)return-1;if(this.sortField==="createdAt"||this.sortField==="updatedAt"){const a=new Date(n).getTime(),o=new Date(i).getTime();return this.sortDirection==="asc"?a-o:o-a}return typeof n=="string"&&typeof i=="string"?this.sortDirection==="asc"?n.localeCompare(i):i.localeCompare(n):this.sortDirection==="asc"?n-i:i-n})},get attachmentsText(){return(Array.isArray(this.editingTask.attachments)?this.editingTask.attachments:[]).join(`
`)},set attachmentsText(t){typeof t=="string"?this.editingTask.attachments=t.split(`
`):this.editingTask.attachments=[]},testFiltering(){if(console.group("SchedulerSettings Debug: Filter Test"),console.log("Current Filter Settings:"),console.log("- Filter Type:",this.filterType),console.log("- Filter State:",this.filterState),console.log("- Sort Field:",this.sortField),console.log("- Sort Direction:",this.sortDirection),!Array.isArray(this.tasks)){console.error("ERROR: this.tasks is not an array!",this.tasks),console.groupEnd();return}console.log(`Raw Tasks (${this.tasks.length}):`,this.tasks),console.group("Filter by Type Test"),["all","adhoc","scheduled","recurring"].forEach(t=>{const e=this.tasks.filter(s=>t==="all"||s.type&&String(s.type).toLowerCase()===t);console.log(`Type "${t}": ${e.length} tasks`,e)}),console.groupEnd(),console.group("Filter by State Test"),["all","idle","running","completed","failed"].forEach(t=>{const e=this.tasks.filter(s=>t==="all"||s.state&&String(s.state).toLowerCase()===t);console.log(`State "${t}": ${e.length} tasks`,e)}),console.groupEnd(),console.log("Current Filtered Tasks:",this.filteredTasks),console.groupEnd()},debugTasks(){if(console.group("SchedulerSettings Comprehensive Debug"),console.log("Component State:"),console.log({filterType:this.filterType,filterState:this.filterState,sortField:this.sortField,sortDirection:this.sortDirection,isLoading:this.isLoading,isEditing:this.isEditing,isCreating:this.isCreating,viewMode:this.viewMode}),!this.tasks){console.error("ERROR: this.tasks is undefined or null!"),console.groupEnd();return}if(!Array.isArray(this.tasks)){console.error("ERROR: this.tasks is not an array!",typeof this.tasks,this.tasks),console.groupEnd();return}console.group("Raw Tasks"),console.log(`Count: ${this.tasks.length}`),this.tasks.length>0?(console.table(this.tasks.map(n=>({uuid:n.uuid,name:n.name,type:n.type,state:n.state}))),console.log("First Task Structure:",JSON.stringify(this.tasks[0],null,2))):console.log("No tasks available"),console.groupEnd(),console.group("Filtered Tasks");const t=this.filteredTasks;if(console.log(`Count: ${t.length}`),t.length>0?console.table(t.map(n=>({uuid:n.uuid,name:n.name,type:n.type,state:n.state}))):console.log("No filtered tasks"),console.groupEnd(),console.group("Potential Issues"),this.tasks.length>0&&t.length===0){console.warn("Filter seems to exclude all tasks. Checking why:");const n=[...new Set(this.tasks.map(a=>a.type))];console.log("Unique task types in data:",n);const i=[...new Set(this.tasks.map(a=>a.state))];if(console.log("Unique task states in data:",i),this.filterType!=="all"){const a=this.tasks.some(o=>o.type&&String(o.type).toLowerCase()===this.filterType.toLowerCase());console.log(`Type "${this.filterType}" matches found:`,a)}if(this.filterState!=="all"){const a=this.tasks.some(o=>o.state&&String(o.state).toLowerCase()===this.filterState.toLowerCase());console.log(`State "${this.filterState}" matches found:`,a)}}const e=this.tasks.some(n=>n.type===void 0||n.type===null),s=this.tasks.some(n=>n.state===void 0||n.state===null);e&&console.warn("Some tasks have undefined or null type values!"),s&&console.warn("Some tasks have undefined or null state values!"),console.groupEnd(),console.groupEnd()},initFlatpickr(t="all"){const e=(s,n,i,a={})=>{let o=this.$refs[n];if(o||(o=document.getElementById(s),console.log(`Using getElementById fallback for ${s}`)),!o)return console.warn(`Input element ${s} not found by ID or ref`),null;const r=document.createElement("div");r.className=i||"scheduler-flatpickr-wrapper",r.style.overflow="visible",o.parentNode.insertBefore(r,o),r.appendChild(o),o.classList.add("scheduler-flatpickr-input");const l={...{dateFormat:"Y-m-d H:i",enableTime:!0,time_24hr:!0,static:!1,appendTo:document.body,theme:"scheduler-theme",allowInput:!0,positionElement:r,onOpen:function(h,g,p){p.calendarContainer.style.zIndex="9999",p.calendarContainer.style.position="absolute",p.calendarContainer.style.visibility="visible",p.calendarContainer.style.opacity="1",p.calendarContainer.classList.add("scheduler-theme")},onReady:function(h,g,p){if(!g){const f=new Date;f.setMinutes(f.getMinutes()+30),p.setDate(f,!0)}}},...a},d=flatpickr(o,l),u=document.createElement("button");return u.className="scheduler-flatpickr-clear",u.innerHTML="×",u.type="button",u.addEventListener("click",h=>{h.preventDefault(),h.stopPropagation(),d&&d.clear()}),r.appendChild(u),d};if(t==="all"||t==="create"){const s=document.getElementById("newPlannedTime-create");s&&s._flatpickr&&s._flatpickr.destroy()}if(t==="all"||t==="edit"){const s=document.getElementById("newPlannedTime-edit");s&&s._flatpickr&&s._flatpickr.destroy()}(t==="all"||t==="create")&&e("newPlannedTime-create","plannedTimeCreate","scheduler-flatpickr-wrapper",{minuteIncrement:5,defaultHour:new Date().getHours(),defaultMinute:Math.ceil(new Date().getMinutes()/5)*5}),(t==="all"||t==="edit")&&e("newPlannedTime-edit","plannedTimeEdit","scheduler-flatpickr-wrapper",{minuteIncrement:5,defaultHour:new Date().getHours(),defaultMinute:Math.ceil(new Date().getMinutes()/5)*5})},updateTasksUI(){typeof this.updateFilteredTasks=="function"&&this.updateFilteredTasks(),this.$nextTick(()=>{const t=document.querySelector(".scheduler-empty"),e=document.querySelector(".scheduler-task-list"),s=Array.isArray(this.filteredTasks)&&this.filteredTasks.length>0;t&&(t.style.display=s?"none":""),e&&(e.style.display=s?"":"none")})}}};if(!window.schedulerSettings)console.log("Defining schedulerSettings component from scratch"),window.schedulerSettings=lt;else{console.log("Extending existing schedulerSettings component");const t=window.schedulerSettings;window.schedulerSettings=function(){const e=t(),s=e.init||function(){};return e.init=function(){s.call(this),console.log("Enhanced init running: adding missing methods to component");const n=lt();["fetchTasks","startPolling","stopPolling","startCreateTask","startEditTask","cancelEdit","saveTask","runTask","resetTaskState","deleteTask","toggleTaskExpand","showTaskDetail","closeTaskDetail","changeSort","formatDate","formatPlan","formatSchedule","getStateBadgeClass","generateRandomToken","testFiltering","debugTasks","sortTasks","initFlatpickr","initDateTimeInput","updateTasksUI"].forEach(a=>{typeof this[a]!="function"&&typeof n[a]=="function"&&(console.log(`Adding missing method: ${a}`),this[a]=n[a])}),window.deleteTaskGlobal=this.deleteTask.bind(this),this.filteredTasks=[],Array.isArray(this.tasks)||(this.tasks=[]),Object.getOwnPropertyDescriptor(this,"attachmentsText")?.get||Object.defineProperty(this,"attachmentsText",{get:function(){return(Array.isArray(this.editingTask?.attachments)?this.editingTask.attachments:[]).join(`
`)},set:function(a){this.editingTask||(this.editingTask={attachments:[]}),typeof a=="string"?this.editingTask.attachments=a.split(`
`):this.editingTask.attachments=[]}}),typeof this.updateFilteredTasks!="function"&&(this.updateFilteredTasks=function(){if(!Array.isArray(this.tasks)){this.filteredTasks=[];return}let a=[...this.tasks];this.filterType&&this.filterType!=="all"&&(a=a.filter(o=>o.type?String(o.type).toLowerCase()===this.filterType.toLowerCase():!1)),this.filterState&&this.filterState!=="all"&&(a=a.filter(o=>o.state?String(o.state).toLowerCase()===this.filterState.toLowerCase():!1)),typeof this.sortTasks=="function"&&(a=this.sortTasks(a)),this.filteredTasks=a}),this.$nextTick(()=>{this.$watch("tasks",()=>{this.updateFilteredTasks()}),this.$watch("filterType",()=>{this.updateFilteredTasks()}),this.$watch("filterState",()=>{this.updateFilteredTasks()}),this.$watch("sortField",()=>{this.updateFilteredTasks()}),this.$watch("sortDirection",()=>{this.updateFilteredTasks()}),this.updateFilteredTasks(),this.$watch("editingTask.type",a=>{a==="planned"&&this.$nextTick(()=>{this.isCreating?this.initFlatpickr("create"):this.isEditing&&this.initFlatpickr("edit")})}),this.$nextTick(()=>{typeof this.initFlatpickr=="function"?this.initFlatpickr():console.error("initFlatpickr is not available")})}),setTimeout(()=>{typeof this.fetchTasks=="function"?this.fetchTasks():console.error("fetchTasks still not available after enhancement")},100),console.log("Enhanced init complete")},e}}window.Alpine?(console.log("Alpine already loaded, registering schedulerSettings component now"),window.Alpine.data("schedulerSettings",window.schedulerSettings)):document.addEventListener("alpine:init",()=>{console.log("Alpine:init - immediately registering schedulerSettings component"),Alpine.data("schedulerSettings",window.schedulerSettings)});document.addEventListener("DOMContentLoaded",function(){console.log("DOMContentLoaded - setting up scheduler tab click handler");const t=()=>{const e=document.getElementById("settingsModal");if(!e){setTimeout(t,100);return}document.addEventListener("click",function(s){if(s.target.closest('.settings-tab[title="Task Scheduler"]')){s.preventDefault(),s.stopPropagation();try{const i=Alpine.$data(e);i.activeTab!=="scheduler"&&i.switchTab("scheduler"),setTimeout(()=>{const a=document.querySelector('[x-data="schedulerSettings"]');if(a){const o=Alpine.$data(a);typeof o.fetchTasks=="function"?o.fetchTasks():console.error("fetchTasks is not a function on scheduler component"),typeof o.startPolling=="function"?o.startPolling():console.error("startPolling is not a function on scheduler component")}else console.error("Could not find scheduler component element")},100)}catch(i){console.error("Error handling scheduler tab click:",i)}}},!0)};t()});async function fn(){try{const t=await window.sendJsonData("/history_get",{context:Se()}),e=t.history,s=t.tokens;await zt(e,"markdown",`History ~${s} tokens`,"Conversation history visible to the LLM. History is compressed to fit into the context window over time.")}catch(t){window.toastFetchError("Error fetching history",t);return}}async function mn(){try{const t=await window.sendJsonData("/ctx_window_get",{context:Se()}),e=t.content,s=t.tokens;await zt(e,"markdown",`Context window ~${s} tokens`,"Data passed to the LLM during last interaction. Contains system message, conversation history and RAG.")}catch(t){window.toastFetchError("Error fetching context",t);return}}async function zt(t,e="json",s,n=""){const i='<div id="json-viewer-container"></div>';if(await window.genericModalProxy.openModal(s,n,i,["history-viewer"]),document.getElementById("json-viewer-container")){const o=ace.edit("json-viewer-container");localStorage.getItem("darkMode")!="false"?o.setTheme("ace/theme/github_dark"):o.setTheme("ace/theme/tomorrow"),o.session.setMode("ace/mode/"+e),o.setValue(t),o.clearSelection()}}window.openHistoryModal=fn;window.openCtxWindowModal=mn;const kn="modulepreload",yn=function(t){return"/"+t},ct={},$e=function(e,s,n){if(!s||s.length===0)return e();const i=document.getElementsByTagName("link");return Promise.all(s.map(a=>{if(a=yn(a),a in ct)return;ct[a]=!0;const o=a.endsWith(".css"),r=o?'[rel="stylesheet"]':"";if(!!n)for(let d=i.length-1;d>=0;d--){const u=i[d];if(u.href===a&&(!o||u.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${a}"]${r}`))return;const l=document.createElement("link");if(l.rel=o?"stylesheet":kn,o||(l.as="script",l.crossOrigin=""),l.href=a,document.head.appendChild(l),o)return new Promise((d,u)=>{l.addEventListener("load",d),l.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${a}`)))})})).then(()=>e()).catch(a=>{const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=a,window.dispatchEvent(o),!o.defaultPrevented)throw a})},F={};async function Qe(t,e){try{if(!e)throw new Error("Target element is required");e.innerHTML='<div class="loading"></div>';const s="components/"+t;let n;if(F[s])n=F[s];else{const d=await fetch(s);if(!d.ok)throw new Error(`Error loading component ${t}: ${d.statusText}`);n=await d.text(),F[s]=n}const a=new DOMParser().parseFromString(n,"text/html"),o=[...a.querySelectorAll("style"),...a.querySelectorAll("script"),...a.body.childNodes],r=[];let c=0;for(const d of o)if(d.nodeName==="SCRIPT")if(d.type==="module"||d.getAttribute("type")==="module")if(d.src){const h=new URL(d.src,globalThis.location.origin).toString();if(!F[h]){const g=$e(()=>import(h),[]);F[h]=g,r.push(g)}}else{const h=`${s.replaceAll("/","_")}.${++c}.js`;if(!F[h]){let g=d.textContent.replace(/import\s+([^'"]+)\s+from\s+["']([^"']+)["']/g,(I,ae,G)=>{if(!/^https?:\/\//.test(G)){const oe=new URL(G,globalThis.location.origin).href;return`import ${ae} from "${oe}"`}return I});g+=`
//# sourceURL=${h}`;const p=new Blob([g],{type:"text/javascript"}),f=URL.createObjectURL(p),T=$e(()=>import(f),[]).catch(I=>{throw console.error("Failed to load inline module",I),I}).finally(()=>URL.revokeObjectURL(f));F[h]=T,r.push(T)}}else{const h=document.createElement("script");if(Array.from(d.attributes||[]).forEach(g=>{h.setAttribute(g.name,g.value)}),h.textContent=d.textContent,h.src){const g=new Promise((p,f)=>{h.onload=p,h.onerror=f});r.push(g)}e.appendChild(h)}else if(d.nodeName==="STYLE"||d.nodeName==="LINK"&&d.rel==="stylesheet"){const u=d.cloneNode(!0);if(u.tagName==="LINK"&&u.rel==="stylesheet"){const h=new Promise((g,p)=>{u.onload=g,u.onerror=p});r.push(h)}e.appendChild(u)}else{const u=d.cloneNode(!0);e.appendChild(u)}await Promise.all(r);const l=e.querySelector(".loading");return l&&e.removeChild(l),a}catch(s){throw console.error("Error importing component:",s),s}}async function _e(t=[document.documentElement]){try{const s=(Array.isArray(t)?t:[t]).flatMap(n=>Array.from(n.querySelectorAll("x-component")));if(s.length===0)return;await Promise.all(s.map(async n=>{const i=n.getAttribute("path");if(!i){console.error("x-component missing path attribute:",n);return}await Qe(i,n)}))}catch(e){console.error("Error loading components:",e)}}function wn(t){let e=t,s={};for(;e;){if(e.tagName.toLowerCase()==="x-component")for(let n of e.attributes)try{s[n.name]=JSON.parse(n.value)}catch{s[n.name]=n.value}e=e.parentElement}return s}globalThis.xAttrs=wn;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>_e()):_e();const Tn=new MutationObserver(t=>{for(const e of t)for(const s of e.addedNodes)s.nodeType===1&&(s.matches?.("x-component")?Qe(s.getAttribute("path"),s):s.querySelectorAll&&_e([s]))});Tn.observe(document.body,{childList:!0,subtree:!0});const b=[],L=document.createElement("div");L.className="modal-backdrop";L.style.display="none";L.style.backdropFilter="blur(5px)";L.addEventListener("click",t=>{t.target===L&&te()});document.body.appendChild(L);function Ke(){if(b.forEach((e,s)=>{e.element.style.zIndex=3e3+s*20}),L.style.display="block",b.length>1){const s=3e3+(b.length-1-1)*20;L.style.zIndex=s+10}else b.length===1?L.style.zIndex=3e3-1:L.style.display="none"}function bn(t){const e=document.createElement("div");e.className="modal",e.modalName=t,e.addEventListener("click",n=>{n.target===e&&te()}),e.innerHTML=`
    <div class="modal-inner">
      <div class="modal-header">
        <h2 class="modal-title"></h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-scroll">
        <div class="modal-bd"></div>
      </div>
    </div>
  `;const s=e.querySelector(".modal-close");return s.addEventListener("click",()=>te()),document.body.appendChild(e),e.classList.add("show"),Ke(),{element:e,title:e.querySelector(".modal-title"),body:e.querySelector(".modal-bd"),close:s,styles:[],scripts:[]}}function Ft(t){return new Promise(e=>{try{const s=bn();new MutationObserver((i,a)=>!document.contains(s.element)&&(a.disconnect(),e())).observe(document.body,{childList:!0,subtree:!0}),s.body.innerHTML='<div class="loading">Loading...</div>',Qe(t,s.body).then(i=>{s.title.innerHTML=i.title||t}).catch(i=>{console.error("Error loading modal content:",i),s.body.innerHTML=`<div class="error">Failed to load modal content: ${i.message}</div>`}),b.push(s),s.element.classList.add("show"),document.body.style.overflow="hidden",Ke()}catch(s){console.error("Error loading modal content:",s),e()}})}function te(t=null){if(b.length===0)return;let e=b.length-1,s;if(t){if(e=b.findIndex(n=>n.modalName===t),e===-1)return;s=b[e],b.splice(e,1)}else s=b.pop();s.styles.forEach(n=>{document.querySelector(`[data-modal-style="${n}"]`)?.remove()}),s.scripts.forEach(n=>{document.querySelector(`[data-modal-script="${n}"]`)?.remove()}),s.element.classList.remove("show"),s.element.addEventListener("transitionend",()=>{s.element.parentNode&&s.element.parentNode.removeChild(s.element)},{once:!0}),setTimeout(()=>{s.element.parentNode&&s.element.parentNode.removeChild(s.element)},500),b.length===0?(L.style.display="none",document.body.style.overflow=""):Ke()}function Bt(t){if(!t)return;const e=b[b.length-1].element;if(!e)return;const s=e.querySelector(".modal-scroll"),n=e.querySelector(`#${t}`);s&&n&&s.scrollTo({top:n.offsetTop-20,behavior:"smooth"})}globalThis.scrollModal=Bt;document.addEventListener("click",async t=>{const e=t.target.closest("[data-modal-content]");if(e){if(t.preventDefault(),e.hasAttribute("disabled")||e.classList.contains("disabled"))return;const s=e.getAttribute("href");await Ft(s)}});document.addEventListener("keydown",t=>{t.key==="Escape"&&b.length>0&&te()});globalThis.openModal=Ft;globalThis.closeModal=te;globalThis.scrollModal=Bt;await $e(()=>import("./alpine.min-fd199a7a.js"),[]);Alpine.directive("destroy",(t,{expression:e},{evaluateLater:s,cleanup:n})=>{const i=s(e);n(()=>i())});
