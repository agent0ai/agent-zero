<html>
<head>
  <title>Agent Orchestrator</title>
  <script type="module">
    import { store } from "/components/modals/orchestrator/orchestrator-store.js";
  </script>
</head>
<body>
  <div x-data>
    <template x-if="$store.orchestrator">
      <div class="orch-container"
           x-init="$store.orchestrator.onOpen()"
           x-destroy="$store.orchestrator.onClose()">

        <!-- Flow list view -->
        <template x-if="$store.orchestrator.showFlowList">
          <div class="orch-flow-list">
            <div class="orch-flow-list-header">
              <h3>Orchestration Flows</h3>
              <button class="btn btn-ok" @click="$store.orchestrator.newFlow()">
                <span class="material-symbols-outlined" style="font-size:18px;margin-right:4px;">add</span>
                New Flow
              </button>
            </div>

            <!-- Templates section -->
            <template x-if="$store.orchestrator.templates.length > 0">
              <div class="orch-templates-section">
                <div class="orch-section-title">Templates</div>
                <template x-for="tpl in $store.orchestrator.templates" :key="tpl.name">
                  <div class="orch-template-item" @click="$store.orchestrator.useTemplate(tpl)">
                    <span class="material-symbols-outlined orch-template-icon">dashboard_customize</span>
                    <div class="orch-flow-item-info">
                      <span class="orch-flow-item-name" x-text="tpl.name"></span>
                      <span class="orch-flow-item-desc" x-text="tpl.description || 'Built-in template'"></span>
                    </div>
                  </div>
                </template>
                <div class="orch-template-divider"></div>
              </div>
            </template>

            <!-- User flows section -->
            <div class="orch-section-title" x-show="$store.orchestrator.templates.length > 0">Your Flows</div>

            <div class="orch-flow-list-empty" x-show="$store.orchestrator.flows.length === 0">
              <span class="material-symbols-outlined" style="font-size:48px;opacity:0.3;">account_tree</span>
              <p>No flows yet. Create one or pick a template above.</p>
            </div>

            <template x-for="flow in $store.orchestrator.flows" :key="flow.filename">
              <div class="orch-flow-item">
                <div class="orch-flow-item-main" @click="$store.orchestrator.loadFlow(flow.filename)">
                  <span class="material-symbols-outlined">account_tree</span>
                  <div class="orch-flow-item-info">
                    <span class="orch-flow-item-name" x-text="flow.name"></span>
                    <span class="orch-flow-item-desc" x-text="flow.description || 'No description'"></span>
                  </div>
                </div>
                <button class="orch-flow-item-delete"
                        @click.stop="$confirmClick($event, () => $store.orchestrator.deleteFlow(flow.filename))"
                        title="Delete flow">
                  <span class="material-symbols-outlined">delete</span>
                </button>
              </div>
            </template>
          </div>
        </template>

        <!-- Canvas view -->
        <template x-if="!$store.orchestrator.showFlowList">
          <div class="orch-canvas-view">

            <!-- Toolbar -->
            <div class="orch-toolbar">
              <button class="orch-toolbar-btn" @click="$store.orchestrator.backToFlowList()" title="Back to flows">
                <span class="material-symbols-outlined">arrow_back</span>
              </button>
              <input class="orch-toolbar-name-input"
                     type="text"
                     :value="$store.orchestrator.currentFlowName"
                     @input="$store.orchestrator.currentFlowName = $event.target.value; if ($store.orchestrator.currentFlow) $store.orchestrator.currentFlow.name = $event.target.value; $store.orchestrator.dirty = true;"
                     @keydown.enter="$event.target.blur()"
                     spellcheck="false">
              <span class="orch-toolbar-dirty" x-show="$store.orchestrator.dirty">*</span>
              <div class="orch-toolbar-spacer"></div>
              <div class="orch-run-group" x-show="!$store.orchestrator.running" x-data="{ promptInput: '' }">
                <input type="text" class="orch-prompt-input"
                       x-model="promptInput"
                       placeholder="User prompt..."
                       @keydown.enter="$store.orchestrator.executeFlow(promptInput); promptInput = '';">
                <button class="orch-toolbar-btn"
                        @click="$store.orchestrator.executeFlow(promptInput); promptInput = '';"
                        title="Run flow">
                  <span class="material-symbols-outlined" style="color:#4ade80;">play_arrow</span>
                </button>
              </div>
              <button class="orch-toolbar-btn"
                      @click="$store.orchestrator.stopFlow()"
                      x-show="$store.orchestrator.running"
                      title="Stop flow">
                <span class="material-symbols-outlined" style="color:#f87171;">stop</span>
              </button>
            </div>

            <!-- Execution result banner -->
            <template x-if="!$store.orchestrator.running && $store.orchestrator.executionError">
              <div class="orch-result-banner orch-result-error">
                <span class="material-symbols-outlined">error</span>
                <span x-text="$store.orchestrator.executionError"></span>
                <button class="orch-result-dismiss" @click="$store.orchestrator.dismissResults()">
                  <span class="material-symbols-outlined">close</span>
                </button>
              </div>
            </template>
            <template x-if="!$store.orchestrator.running && $store.orchestrator.finalOutput !== null && !$store.orchestrator.executionError">
              <div class="orch-result-panel">
                <div class="orch-result-banner orch-result-success">
                  <span class="material-symbols-outlined">check_circle</span>
                  <span>Flow completed</span>
                  <div class="orch-result-actions">
                    <button class="orch-result-action-btn" title="Copy output"
                            @click="navigator.clipboard.writeText($store.orchestrator.finalOutput); $event.target.closest('button').classList.add('copied'); setTimeout(() => $event.target.closest('button').classList.remove('copied'), 1500)">
                      <span class="material-symbols-outlined">content_copy</span>
                    </button>
                    <button class="orch-result-action-btn" title="Send to chat"
                            @click="$store.orchestrator.sendResultToChat()">
                      <span class="material-symbols-outlined">send</span>
                    </button>
                    <button class="orch-result-action-btn" title="Toggle output"
                            @click="$store.orchestrator.showOutputPanel = !$store.orchestrator.showOutputPanel">
                      <span class="material-symbols-outlined"
                            x-text="$store.orchestrator.showOutputPanel ? 'expand_less' : 'expand_more'"></span>
                    </button>
                    <button class="orch-result-dismiss" @click="$store.orchestrator.dismissResults()">
                      <span class="material-symbols-outlined">close</span>
                    </button>
                  </div>
                </div>
                <div class="orch-output-panel" x-show="$store.orchestrator.showOutputPanel"
                     x-transition:enter="orch-panel-enter"
                     x-transition:leave="orch-panel-leave">
                  <pre class="orch-output-full" x-text="$store.orchestrator.finalOutput"></pre>
                </div>
              </div>
            </template>

            <!-- Canvas + Inspector layout -->
            <div class="orch-canvas-area">
              <!-- React Flow mount point -->
              <div id="react-flow-root" class="orch-react-root"
                   x-init="
                     import('/components/modals/orchestrator/orchestrator-bridge.js').then(b => b.initBridge($store.orchestrator));
                     import('/components/modals/orchestrator/react/OrchestrationCanvas.js').then(m => {
                       const el = document.getElementById('react-flow-root');
                       if (el) m.mountCanvas(el);
                     });
                   "
                   x-destroy="
                     import('/components/modals/orchestrator/orchestrator-bridge.js').then(b => b.destroyBridge());
                   ">
                <div class="orch-loading" x-show="!$store.orchestrator.reactReady">
                  <span class="material-symbols-outlined orch-loading-icon">hourglass_empty</span>
                  <span>Loading React Flow...</span>
                </div>
              </div>

              <!-- Inspector drawer -->
              <div class="orch-inspector"
                   x-show="$store.orchestrator.showInspector"
                   x-transition:enter="orch-slide-in"
                   x-transition:enter-start="orch-slide-start"
                   x-transition:enter-end="orch-slide-end"
                   x-transition:leave="orch-slide-out"
                   x-transition:leave-start="orch-slide-end"
                   x-transition:leave-end="orch-slide-start">

                <div class="orch-inspector-header">
                  <span x-text="$store.orchestrator.inspectedNodeData?.label || 'Node'"></span>
                  <button class="orch-inspector-close" @click="$store.orchestrator.showInspector = false; $store.orchestrator.inspectedNodeId = null;">
                    <span class="material-symbols-outlined">close</span>
                  </button>
                </div>

                <div class="orch-inspector-body">
                  <!-- Running/completed state: show status + output -->
                  <template x-if="$store.orchestrator.hasExecutionState && $store.orchestrator.inspectedNodeId">
                    <div class="orch-inspector-live">
                      <div class="orch-inspector-status">
                        <span class="orch-status-dot"
                              :class="'status-' + ($store.orchestrator.nodeStates[$store.orchestrator.inspectedNodeId] || 'pending')"></span>
                        <span x-text="$store.orchestrator.nodeStates[$store.orchestrator.inspectedNodeId] || 'pending'"></span>
                      </div>
                      <template x-if="$store.orchestrator.nodeOutputs[$store.orchestrator.inspectedNodeId]">
                        <div class="orch-inspector-output">
                          <label class="orch-field-label">Output</label>
                          <pre class="orch-output-pre" x-text="$store.orchestrator.nodeOutputs[$store.orchestrator.inspectedNodeId]"></pre>
                        </div>
                      </template>
                    </div>
                  </template>

                  <!-- Edit state: show config (hidden while execution results are shown) -->
                  <template x-if="!$store.orchestrator.hasExecutionState && $store.orchestrator.inspectedNodeData">
                    <div class="orch-inspector-config">
                      <!-- Label -->
                      <label class="orch-field-label">Label</label>
                      <input type="text" class="orch-field-input"
                             :value="$store.orchestrator.inspectedNodeData?.label || ''"
                             @input="$store.orchestrator.updateNodeConfig($store.orchestrator.inspectedNodeId, { label: $event.target.value })">

                      <!-- Input-specific fields -->
                      <template x-if="$store.orchestrator.inspectedNodeData?.promptMode !== undefined">
                        <div>
                          <label class="orch-field-label">Prompt Mode</label>
                          <select class="orch-field-input"
                                  :value="$store.orchestrator.inspectedNodeData?.promptMode || 'runtime'"
                                  @change="$store.orchestrator.updateNodeConfig($store.orchestrator.inspectedNodeId, { promptMode: $event.target.value })">
                            <option value="runtime">Runtime (user provides)</option>
                            <option value="fixed">Fixed prompt</option>
                          </select>
                          <template x-if="$store.orchestrator.inspectedNodeData?.promptMode === 'fixed'">
                            <div>
                              <label class="orch-field-label">Fixed Prompt</label>
                              <textarea class="orch-field-textarea"
                                        :value="$store.orchestrator.inspectedNodeData?.fixedPrompt || ''"
                                        @input="$store.orchestrator.updateNodeConfig($store.orchestrator.inspectedNodeId, { fixedPrompt: $event.target.value })"
                                        placeholder="Enter the fixed prompt text..."></textarea>
                            </div>
                          </template>
                        </div>
                      </template>

                      <!-- Agent-specific fields -->
                      <template x-if="$store.orchestrator.inspectedNodeData?._nodeType === 'agentNode' || $store.orchestrator.inspectedNodeData?.agentProfile !== undefined">
                        <div>
                          <label class="orch-field-label">Agent Profile</label>
                          <select class="orch-field-input"
                                  :value="$store.orchestrator.inspectedNodeData?.agentProfile || 'default'"
                                  @change="$store.orchestrator.updateNodeConfig($store.orchestrator.inspectedNodeId, { agentProfile: $event.target.value })">
                            <template x-for="p in $store.orchestrator.agentProfiles" :key="p.key">
                              <option :value="p.key" x-text="p.label || p.key"></option>
                            </template>
                          </select>

                          <label class="orch-field-label">Prompt Override</label>
                          <textarea class="orch-field-textarea"
                                    :value="$store.orchestrator.inspectedNodeData?.systemPromptOverride || ''"
                                    @input="$store.orchestrator.updateNodeConfig($store.orchestrator.inspectedNodeId, { systemPromptOverride: $event.target.value })"
                                    placeholder="Optional system prompt override..."></textarea>
                        </div>
                      </template>

                      <!-- Condition-specific fields -->
                      <template x-if="$store.orchestrator.inspectedNodeData?.expression !== undefined">
                        <div>
                          <label class="orch-field-label">Expression</label>
                          <textarea class="orch-field-textarea"
                                    :value="$store.orchestrator.inspectedNodeData?.expression || ''"
                                    @input="$store.orchestrator.updateNodeConfig($store.orchestrator.inspectedNodeId, { expression: $event.target.value })"
                                    placeholder="Python expression (e.g. len(input) > 100)"></textarea>

                          <label class="orch-field-label">True Label</label>
                          <input type="text" class="orch-field-input"
                                 :value="$store.orchestrator.inspectedNodeData?.trueLabel || 'True'"
                                 @input="$store.orchestrator.updateNodeConfig($store.orchestrator.inspectedNodeId, { trueLabel: $event.target.value })">

                          <label class="orch-field-label">False Label</label>
                          <input type="text" class="orch-field-input"
                                 :value="$store.orchestrator.inspectedNodeData?.falseLabel || 'False'"
                                 @input="$store.orchestrator.updateNodeConfig($store.orchestrator.inspectedNodeId, { falseLabel: $event.target.value })">
                        </div>
                      </template>

                      <!-- Parallel-specific fields -->
                      <template x-if="$store.orchestrator.inspectedNodeData?.mergeStrategy !== undefined">
                        <div>
                          <label class="orch-field-label">Merge Strategy</label>
                          <select class="orch-field-input"
                                  :value="$store.orchestrator.inspectedNodeData?.mergeStrategy || 'concatenate'"
                                  @change="$store.orchestrator.updateNodeConfig($store.orchestrator.inspectedNodeId, { mergeStrategy: $event.target.value })">
                            <option value="concatenate">Concatenate</option>
                            <option value="summarize">Summarize</option>
                            <option value="first">First Response</option>
                          </select>
                        </div>
                      </template>
                    </div>
                  </template>
                </div>
              </div>
            </div>

          </div>
        </template>

      </div>
    </template>
  </div>

  <!-- Footer -->
  <template x-if="$store.orchestrator">
    <div class="modal-footer" data-modal-footer
         x-show="!$store.orchestrator.showFlowList && $store.orchestrator.currentFlow">
      <button class="btn btn-ok" @click="$store.orchestrator.saveFlow()" :disabled="!$store.orchestrator.dirty">
        Save
      </button>
      <button class="btn btn-cancel" @click="closeModal('modals/orchestrator/orchestrator.html')">
        Close
      </button>
    </div>
  </template>

  <style>
    /* ─── Container ─── */
    .orch-container {
      display: flex;
      flex-direction: column;
      height: 75vh;
      min-height: 500px;
      overflow: hidden;
    }

    /* ─── Flow List ─── */
    .orch-flow-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      height: 100%;
      overflow-y: auto;
    }

    .orch-flow-list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .orch-flow-list-header h3 {
      margin: 0;
      font-size: var(--font-size-large);
      color: var(--color-text);
    }

    .orch-flow-list-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      flex: 1;
      color: var(--color-text);
      opacity: 0.5;
    }

    .orch-flow-item {
      display: flex;
      align-items: center;
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      transition: background var(--transition-speed);
    }

    .orch-flow-item:hover {
      background: var(--color-background-hover, rgba(255,255,255,0.05));
    }

    .orch-flow-item-main {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      flex: 1;
      cursor: pointer;
      min-width: 0;
    }

    .orch-flow-item-delete {
      background: none;
      border: none;
      cursor: pointer;
      padding: var(--spacing-sm);
      color: var(--color-text);
      opacity: 0.3;
      transition: opacity 0.15s;
      flex-shrink: 0;
    }

    .orch-flow-item-delete:hover {
      opacity: 0.8;
      color: #f87171;
    }

    .orch-flow-item-info {
      display: flex;
      flex-direction: column;
    }

    .orch-flow-item-name {
      font-weight: 500;
      color: var(--color-text);
    }

    .orch-flow-item-desc {
      font-size: var(--font-size-small);
      color: var(--color-text);
      opacity: 0.6;
    }

    /* ─── Templates Section ─── */
    .orch-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--color-text);
      opacity: 0.5;
      padding: 0 2px;
    }

    .orch-templates-section {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .orch-template-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-left: 3px solid var(--color-accent, #60a5fa);
      border-radius: 8px;
      cursor: pointer;
      transition: background var(--transition-speed);
    }

    .orch-template-item:hover {
      background: var(--color-background-hover, rgba(255,255,255,0.05));
    }

    .orch-template-icon {
      color: var(--color-accent, #60a5fa);
      opacity: 0.8;
    }

    .orch-template-divider {
      height: 1px;
      background: var(--color-border);
      margin: var(--spacing-xs) 0;
    }

    /* ─── Canvas View ─── */
    .orch-canvas-view {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .orch-toolbar {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-bottom: 1px solid var(--color-border);
      background: var(--color-panel);
      flex-shrink: 0;
    }

    .orch-toolbar-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      color: var(--color-text);
      opacity: 0.7;
      transition: opacity 0.15s;
    }

    .orch-toolbar-btn:hover {
      opacity: 1;
      background: rgba(255,255,255,0.05);
    }

    .orch-toolbar-name-input {
      font-size: var(--font-size-normal);
      color: var(--color-text);
      font-weight: 500;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 4px;
      padding: 2px 6px;
      outline: none;
      max-width: 250px;
    }

    .orch-toolbar-name-input:hover {
      border-color: var(--color-border);
    }

    .orch-toolbar-name-input:focus {
      border-color: var(--color-accent);
      background: var(--color-input, var(--color-background));
    }

    .orch-toolbar-dirty {
      color: var(--color-accent);
      font-weight: bold;
      font-size: 1.2em;
    }

    .orch-toolbar-spacer {
      flex: 1;
    }

    .orch-run-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .orch-prompt-input {
      font-size: var(--font-size-small);
      color: var(--color-text);
      background: var(--color-input, var(--color-background));
      border: 1px solid var(--color-border);
      border-radius: 4px;
      padding: 4px 8px;
      width: 200px;
      outline: none;
    }

    .orch-prompt-input:focus {
      border-color: var(--color-accent);
    }

    /* ─── Canvas Area ─── */
    .orch-canvas-area {
      display: flex;
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .orch-react-root {
      flex: 1;
      position: relative;
      min-height: 0;
    }

    .orch-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: var(--spacing-sm);
      color: var(--color-text);
      opacity: 0.5;
    }

    .orch-loading-icon {
      font-size: 32px;
      animation: orch-spin 1.5s linear infinite;
    }

    @keyframes orch-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* ─── Inspector Drawer ─── */
    .orch-inspector {
      width: 320px;
      flex-shrink: 0;
      border-left: 1px solid var(--color-border);
      background: var(--color-panel);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .orch-slide-in,
    .orch-slide-out {
      transition: transform 0.2s ease, opacity 0.2s ease;
    }

    .orch-slide-start {
      transform: translateX(100%);
      opacity: 0;
    }

    .orch-slide-end {
      transform: translateX(0);
      opacity: 1;
    }

    .orch-inspector-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-sm) var(--spacing-md);
      border-bottom: 1px solid var(--color-border);
      font-weight: 600;
      color: var(--color-text);
    }

    .orch-inspector-close {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--color-text);
      opacity: 0.6;
      padding: 2px;
    }

    .orch-inspector-close:hover {
      opacity: 1;
    }

    .orch-inspector-body {
      padding: var(--spacing-md);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .orch-field-label {
      font-size: var(--font-size-small);
      color: var(--color-text);
      opacity: 0.7;
      margin-bottom: 2px;
      display: block;
    }

    .orch-field-input {
      width: 100%;
      padding: 6px 8px;
      background: var(--color-input, var(--color-background));
      border: 1px solid var(--color-border);
      border-radius: 4px;
      color: var(--color-text);
      font-size: var(--font-size-small);
      margin-bottom: var(--spacing-sm);
    }

    .orch-field-textarea {
      width: 100%;
      min-height: 60px;
      padding: 6px 8px;
      background: var(--color-input, var(--color-background));
      border: 1px solid var(--color-border);
      border-radius: 4px;
      color: var(--color-text);
      font-size: var(--font-size-small);
      resize: vertical;
      font-family: inherit;
      margin-bottom: var(--spacing-sm);
    }

    /* ─── Inspector Live Output ─── */
    .orch-inspector-live {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .orch-inspector-status {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      text-transform: capitalize;
      font-size: var(--font-size-small);
    }

    .orch-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: gray;
    }

    .orch-status-dot.status-running {
      background: #60a5fa;
      animation: orch-pulse 1s ease-in-out infinite;
    }

    .orch-status-dot.status-completed { background: #4ade80; }
    .orch-status-dot.status-error { background: #f87171; }
    .orch-status-dot.status-pending { background: #888; }
    .orch-status-dot.status-skipped { background: #666; }

    @keyframes orch-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .orch-inspector-output {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .orch-output-pre {
      font-size: var(--font-size-small);
      white-space: pre-wrap;
      word-break: break-word;
      color: var(--color-text);
      opacity: 0.8;
      max-height: 200px;
      overflow-y: auto;
      background: var(--color-background);
      padding: var(--spacing-sm);
      border-radius: 4px;
      margin: 0;
      font-family: monospace;
    }

    /* ─── Result Panel ─── */
    .orch-result-panel {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }

    .orch-result-banner {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: 6px 12px;
      font-size: var(--font-size-small);
      flex-shrink: 0;
    }

    .orch-result-success {
      background: rgba(74, 222, 128, 0.1);
      color: #4ade80;
      border-bottom: 1px solid rgba(74, 222, 128, 0.2);
    }

    .orch-result-error {
      background: rgba(248, 113, 113, 0.1);
      color: #f87171;
      border-bottom: 1px solid rgba(248, 113, 113, 0.2);
    }

    .orch-result-banner .material-symbols-outlined {
      font-size: 18px;
    }

    .orch-result-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .orch-result-action-btn {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      opacity: 0.6;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
    }
    .orch-result-action-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); }
    .orch-result-action-btn .material-symbols-outlined { font-size: 16px; }
    .orch-result-action-btn.copied .material-symbols-outlined::after { content: " ✓"; font-size: 11px; }

    .orch-result-dismiss {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      opacity: 0.6;
      padding: 4px;
      display: flex;
      align-items: center;
    }
    .orch-result-dismiss:hover { opacity: 1; }
    .orch-result-dismiss .material-symbols-outlined { font-size: 16px; }

    .orch-output-panel {
      max-height: 40vh;
      overflow-y: auto;
      border-bottom: 1px solid var(--color-border);
      background: var(--color-background);
    }

    .orch-panel-enter {
      transition: max-height 0.2s ease, opacity 0.2s ease;
    }
    .orch-panel-leave {
      transition: max-height 0.15s ease, opacity 0.15s ease;
    }

    .orch-output-full {
      margin: 0;
      padding: var(--spacing-md);
      font-family: monospace;
      font-size: var(--font-size-small);
      white-space: pre-wrap;
      word-break: break-word;
      color: var(--color-text);
      line-height: 1.5;
    }

    /* ─── React Flow Node Styles ─── */
    .orch-node {
      padding: 12px 16px;
      border-radius: 8px;
      border: 2px solid var(--color-border, #333);
      background: var(--color-panel, #1e1e2e);
      color: var(--color-text, #e0e0e0);
      min-width: 150px;
      font-size: 13px;
      position: relative;
    }

    .orch-node.selected {
      box-shadow: 0 0 0 2px var(--color-accent, #60a5fa);
    }

    .orch-node-badge {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.08em;
      opacity: 0.6;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .orch-node-label {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .orch-node-detail {
      font-size: 11px;
      opacity: 0.5;
    }

    /* Node type colors */
    .orch-node-input { border-color: #4ade80; }
    .orch-node-input .orch-node-badge { color: #4ade80; }

    .orch-node-output { border-color: #f87171; }
    .orch-node-output .orch-node-badge { color: #f87171; }

    .orch-node-agent { border-color: #60a5fa; }
    .orch-node-agent .orch-node-badge { color: #60a5fa; }

    .orch-node-parallel {
      border-color: #c084fc;
      min-width: 200px;
      min-height: 120px;
    }
    .orch-node-parallel .orch-node-badge { color: #c084fc; }

    .orch-node-condition { border-color: #fbbf24; }
    .orch-node-condition .orch-node-badge { color: #fbbf24; }

    .orch-condition-handles {
      position: relative;
      height: 0;
    }

    .orch-condition-labels {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      margin-top: 6px;
      opacity: 0.6;
    }

    .orch-cond-true { color: #4ade80; }
    .orch-cond-false { color: #f87171; }

    /* Node execution states */
    .orch-node.running {
      border-color: #60a5fa;
      box-shadow: 0 0 12px rgba(96, 165, 250, 0.3);
      animation: orch-node-pulse 1.5s ease-in-out infinite;
    }

    .orch-node.completed {
      border-color: #4ade80;
    }

    .orch-node.error {
      border-color: #f87171;
      box-shadow: 0 0 8px rgba(248, 113, 113, 0.3);
    }

    .orch-node.pending {
      border-style: dashed;
      opacity: 0.6;
    }

    .orch-node.skipped {
      border-style: dotted;
      opacity: 0.4;
    }

    @keyframes orch-node-pulse {
      0%, 100% { box-shadow: 0 0 12px rgba(96, 165, 250, 0.3); }
      50% { box-shadow: 0 0 20px rgba(96, 165, 250, 0.6); }
    }

    .orch-node-spinner {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(96, 165, 250, 0.3);
      border-top-color: #60a5fa;
      border-radius: 50%;
      animation: orch-spin 0.8s linear infinite;
    }

    .orch-node-activity {
      font-size: 9px;
      color: rgba(96, 165, 250, 0.9);
      margin-top: 4px;
      max-width: 160px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }

    .orch-node-elapsed {
      font-size: 9px;
      color: rgba(255, 255, 255, 0.4);
      margin-top: 2px;
      font-variant-numeric: tabular-nums;
    }

    /* ─── Node Palette ─── */
    .orch-palette {
      background: var(--color-panel, #1e1e2e);
      border: 1px solid var(--color-border, #333);
      border-radius: 8px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 120px;
    }

    .orch-palette-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.5;
      padding: 2px 4px;
      color: var(--color-text, #e0e0e0);
    }

    .orch-palette-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 4px;
      border-left: 3px solid transparent;
      cursor: grab;
      font-size: 13px;
      color: var(--color-text, #e0e0e0);
      transition: background 0.15s;
    }

    .orch-palette-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .orch-palette-item:active {
      cursor: grabbing;
    }

    /* ─── React Flow overrides ─── */
    .react-flow__handle {
      width: 10px;
      height: 10px;
      background: var(--color-accent, #60a5fa);
      border: 2px solid var(--color-panel, #1e1e2e);
    }

    .react-flow__edge-path {
      stroke: var(--color-border, #555);
      stroke-width: 2;
    }

    .react-flow__controls {
      background: var(--color-panel, #1e1e2e);
      border: 1px solid var(--color-border, #333);
      border-radius: 8px;
    }

    .react-flow__controls-button {
      background: var(--color-panel, #1e1e2e);
      border-color: var(--color-border, #333);
      fill: var(--color-text, #e0e0e0);
    }

    .react-flow__controls-button:hover {
      background: rgba(255,255,255,0.1);
    }
  </style>
</body>
</html>
