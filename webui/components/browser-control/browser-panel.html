<html>
<head>
    <title>Browser Control Panel</title>
    <script type="module">
        import { store } from "/components/browser-control/browser-control-store.js";
    </script>
</head>
<body>
    <div x-data>
        <template x-if="$store.browserControl">
            <div x-data="browserPanel()"
                 x-show="$store.browserControl.isVisible"
                 x-cloak
                 class="browser-panel"
                 :class="{
                     'minimized': $store.browserControl.isMinimized,
                     'maximized': $store.browserControl.isMaximized,
                     'dragging': isDragging
                 }"
                 :style="{
                     left: panelX !== null ? panelX + 'px' : '50%',
                     top: panelY !== null ? panelY + 'px' : '50%',
                     transform: panelX === null ? 'translate(-50%, -50%)' : 'none',
                     transition: isDragging ? 'none' : ''
                 }"
                 x-init="initPosition()">

        <!-- Panel Header -->
        <div class="browser-panel-header" @mousedown="startDrag($event)">
            <div class="browser-panel-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="9" y1="3" x2="9" y2="21"></line>
                </svg>
                <span>Browser Control</span>
            </div>
            <div class="browser-panel-controls">
                <button @click="$store.browserControl.toggleMinimize()" title="Minimize" class="browser-panel-btn">
                    <span x-show="!$store.browserControl.isMinimized">−</span>
                    <span x-show="$store.browserControl.isMinimized">□</span>
                </button>
                <button @click="$store.browserControl.toggleMaximize()"
                        title="Maximize"
                        class="browser-panel-btn"
                        x-show="!$store.browserControl.isMinimized">
                    <span x-show="!$store.browserControl.isMaximized">⛶</span>
                    <span x-show="$store.browserControl.isMaximized">⧉</span>
                </button>
                <button @click="$store.browserControl.hide()" title="Close" class="browser-panel-btn browser-panel-close">×</button>
            </div>
        </div>

        <!-- Panel Content -->
        <div class="browser-panel-content" x-show="!$store.browserControl.isMinimized">
            <iframe
                x-show="$store.browserControl.vncUrl"
                :src="$store.browserControl.vncUrl + '&reconnect=true&quality=9&show_dot=true'"
                class="browser-iframe"
                frameborder="0"
                allow="fullscreen"
                allowfullscreen
            ></iframe>
            <div x-show="!$store.browserControl.vncUrl" class="browser-loading">
                <div class="browser-loading-spinner"></div>
                <p>Connecting to browser...</p>
            </div>
        </div>
            </div>
        </template>
    </div>

    <script>
        function browserPanel() {
            return {
                isDragging: false,
                panelX: null,
                panelY: null,
                dragStart: { x: 0, y: 0 },

                initPosition() {
                    // Watch for visibility changes and re-center when opened
                    this.$watch('$store.browserControl.isVisible', (isVisible) => {
                        if (isVisible && !this.$store.browserControl.isMaximized) {
                            this.recenterPanel();
                        }
                    });

                    // Center on first load if visible
                    if (this.$store.browserControl.isVisible) {
                        this.recenterPanel();
                    }
                },

                recenterPanel() {
                    // Reset position to null to trigger CSS centering
                    this.panelX = null;
                    this.panelY = null;

                    const panel = this.$el;
                    // Use requestAnimationFrame to ensure layout is complete
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            const width = panel.offsetWidth;
                            const height = panel.offsetHeight;
                            this.panelX = Math.max(0, (window.innerWidth - width) / 2);
                            this.panelY = Math.max(0, (window.innerHeight - height) / 2);
                        });
                    });
                },

                startDrag(event) {
                    // Only handle left mouse button
                    if (event.button !== 0) return;

                    event.preventDefault();
                    event.stopPropagation();

                    if (this.$store.browserControl.isMaximized) return;

                    this.isDragging = true;
                    const panel = this.$el;

                    this.dragStart.x = event.clientX - this.panelX;
                    this.dragStart.y = event.clientY - this.panelY;

                    // Disable iframe pointer events
                    const iframe = panel.querySelector('.browser-iframe');
                    if (iframe) iframe.style.pointerEvents = 'none';

                    // Prevent text selection
                    document.body.style.userSelect = 'none';

                    const onMouseMove = (e) => {
                        if (!this.isDragging) return;
                        e.preventDefault();

                        const x = e.clientX - this.dragStart.x;
                        const y = e.clientY - this.dragStart.y;

                        // Keep at least 100px visible
                        const minVisible = 100;
                        const maxX = window.innerWidth - minVisible;
                        const maxY = window.innerHeight - minVisible;
                        const minX = minVisible - panel.offsetWidth;

                        this.panelX = Math.max(minX, Math.min(x, maxX));
                        this.panelY = Math.max(0, Math.min(y, maxY));
                    };

                    const onMouseUp = () => {
                        this.isDragging = false;
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        document.body.style.userSelect = '';
                        if (iframe) iframe.style.pointerEvents = '';
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                }
            };
        }
    </script>

    <script>
        document.addEventListener('alpine:init', () => {
            const s = Alpine.store('browserControl');
            if (s && typeof s.init === 'function') s.init();
        });
    </script>

    <style>
        /* Browser Control Panel Styles */
        .browser-panel {
            position: fixed;
            z-index: 15000;
            background: var(--color-panel);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
            /* Increased size to better accommodate 1920x1080 VNC display */
            width: 800px;
            height: 800px;
        }

        .browser-panel.minimized {
            width: 300px;
            height: 40px;
            bottom: 20px;
            top: auto;
            left: auto;
            right: 20px;
        }

        .browser-panel.maximized {
            width: calc(100vw - 40px) !important;
            height: calc(100vh - 40px) !important;
            top: 20px !important;
            left: 20px !important;
            transform: none !important;
        }

        /* Panel Header */
        .browser-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--color-panel);
            border-bottom: 1px solid var(--color-border);
            cursor: move;
            user-select: none;
        }

        .browser-panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--color-primary);
        }

        .browser-panel-title svg {
            color: var(--color-accent, #4a9eff);
        }

        .browser-panel-controls {
            display: flex;
            gap: 4px;
        }

        .browser-panel-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--color-text);
            font-size: 18px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            opacity: 0.7;
        }

        .browser-panel-btn:hover {
            background: var(--color-panel-hover, rgba(255, 255, 255, 0.1));
            color: var(--color-primary);
            opacity: 1;
        }

        .browser-panel-close:hover {
            background: #e74c3c;
            color: white;
        }

        /* Panel Content */
        .browser-panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            background: #1a1a1a;
        }

        .browser-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Loading State */
        .browser-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--color-text);
        }

        .browser-loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-accent, #4a9eff);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hide when x-cloak is present */
        [x-cloak] {
            display: none !important;
        }

        /* Responsive */
        /* Tablets (landscape and portrait) */
        @media (max-width: 1024px) {
            .browser-panel:not(.maximized):not(.minimized) {
                width: 700px;
                height: 600px;
            }
        }

        /* Mobile devices and small tablets */
        @media (max-width: 768px) {
            .browser-panel:not(.maximized):not(.minimized) {
                width: calc(100vw - 20px);
                height: calc(100vh - 100px);
                left: 10px !important;
                top: 50px !important;
            }

            .browser-panel.minimized {
                width: 250px;
                right: 10px;
                bottom: 10px;
            }

            .browser-panel-header {
                cursor: default;
                -webkit-touch-callout: none;
            }

            .browser-panel-title {
                font-size: 13px;
            }
        }

        /* Extra small devices */
        @media (max-width: 480px) {
            .browser-panel:not(.maximized):not(.minimized) {
                width: calc(100vw - 10px);
                height: calc(100vh - 80px);
                left: 5px !important;
                top: 40px !important;
            }

            .browser-panel.minimized {
                width: 200px;
            }

            .browser-panel-btn {
                width: 28px;
                height: 28px;
                font-size: 16px;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            .browser-panel {
                transition: none;
            }
        }


    </style>
</body>
</html>
