<html>
  <head>
    <title>Utility Model</title>
  </head>

  <body>
    <div x-data>
      <template x-if="$store.settings.settings">
        <div>
          <div class="section-title">Utility model</div>
          <div class="section-description">
            Smaller, cheaper, faster model for handling utility tasks like organizing memory, preparing prompts, summarizing.
          </div>

          <div class="field">
            <div class="field-label">
              <div class="field-title">Utility model provider</div>
              <div class="field-description">Select provider for utility model used by the framework</div>
            </div>
            <div class="field-control">
              <select x-model="$store.settings.settings.util_model_provider">
                <template x-for="option in $store.settings.additional?.chat_providers" :key="'util-provider-' + option.value">
                  <option :value="option.value" :selected="option.value === $store.settings.settings.util_model_provider" x-text="option.label"></option>
                </template>
              </select>
            </div>
          </div>

          <div class="field">
            <div class="field-label">
              <div class="field-title">Utility model name</div>
              <div class="field-description">
                Exact model name. When provider is Codex, choose from available subscription models.
              </div>
            </div>
            <div class="field-control">
              <template x-if="!$store.settings.isCodexProvider($store.settings.settings.util_model_provider)">
                <input type="text" x-model="$store.settings.settings.util_model_name" />
              </template>
              <template x-if="$store.settings.isCodexProvider($store.settings.settings.util_model_provider)">
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <input type="text"
                         list="codex-util-models"
                         x-model="$store.settings.settings.util_model_name" />
                  <datalist id="codex-util-models">
                    <template x-for="model in $store.settings.getCodexModelOptions($store.settings.settings.util_model_name, 'util-model')" :key="model.key">
                      <option :value="model.value" x-text="model.label + (model.available === false ? ' (unavailable)' : '')"></option>
                    </template>
                  </datalist>
                  <button class="btn btn-cancel"
                          :disabled="$store.settings.codexActionLoading"
                          @click="$store.settings.refreshCodexModels(true)">
                    Refresh
                  </button>
                </div>
              </template>
            </div>
          </div>

          <template x-if="!$store.settings.isCodexProvider($store.settings.settings.util_model_provider)">
            <div class="field">
              <div class="field-label">
                <div class="field-title">API key</div>
                <div class="field-description">API key for the selected utility model provider</div>
              </div>
              <div class="field-control">
                <input
                  type="text"
                  x-model="$store.settings.settings.api_keys[$store.settings.settings.util_model_provider]"
                  autocomplete="off"
                />
              </div>
            </div>
          </template>

          <template x-if="$store.settings.isCodexProvider($store.settings.settings.util_model_provider)">
            <div class="field">
              <div class="field-label">
                <div class="field-title">Codex status</div>
                <div class="field-description">
                  API key is not used for Codex. Manage login in
                  <a href="#section-codex-subscription">ChatGPT Subscription</a>.
                </div>
              </div>
              <div class="field-control">
                <div class="field-description">
                  Status:
                  <strong x-text="$store.settings.getCodexStatus()?.logged_in ? 'Connected' : 'Not connected'"></strong>
                </div>
                <template x-if="$store.settings.getCodexStatus()?.diagnostic">
                  <div class="field-description">
                    Diagnostic:
                    <code x-text="$store.settings.getCodexStatus()?.diagnostic"></code>
                  </div>
                </template>
              </div>
            </div>
          </template>

          <div class="field">
            <div class="field-label">
              <div class="field-title">Utility model API base URL</div>
              <div class="field-description">
                API base URL for utility model. Leave empty for default. Only relevant for Azure, local and custom (other) providers.
              </div>
            </div>
            <div class="field-control">
              <input type="text" x-model="$store.settings.settings.util_model_api_base" />
            </div>
          </div>

          <div class="field">
            <div class="field-label">
              <div class="field-title">Requests per minute limit</div>
              <div class="field-description">
                Limits the number of requests per minute to the utility model. Waits if the limit is exceeded. Set to 0 to disable rate limiting.
              </div>
            </div>
            <div class="field-control">
              <input type="number" x-model.number="$store.settings.settings.util_model_rl_requests" />
            </div>
          </div>

          <div class="field">
            <div class="field-label">
              <div class="field-title">Input tokens per minute limit</div>
              <div class="field-description">
                Limits the number of input tokens per minute to the utility model. Waits if the limit is exceeded. Set to 0 to disable rate limiting.
              </div>
            </div>
            <div class="field-control">
              <input type="number" x-model.number="$store.settings.settings.util_model_rl_input" />
            </div>
          </div>

          <div class="field">
            <div class="field-label">
              <div class="field-title">Output tokens per minute limit</div>
              <div class="field-description">
                Limits the number of output tokens per minute to the utility model. Waits if the limit is exceeded. Set to 0 to disable rate limiting.
              </div>
            </div>
            <div class="field-control">
              <input type="number" x-model.number="$store.settings.settings.util_model_rl_output" />
            </div>
          </div>

          <div class="field field-full">
            <div class="field-label">
              <div class="field-title">Utility model additional parameters</div>
              <div class="field-description">
                Any other parameters supported by <a href='https://docs.litellm.ai/docs/set_keys' target='_blank'>LiteLLM</a>. Format is KEY=VALUE on individual lines, like .env file. Value can also contain JSON objects - when unquoted, it is treated as object, number etc., when quoted, it is treated as string.
              </div>
            </div>
            <div class="field-control">
              <textarea x-model="$store.settings.settings.util_model_kwargs"></textarea>
            </div>
          </div>
        </div>
      </template>
    </div>
  </body>
</html>
