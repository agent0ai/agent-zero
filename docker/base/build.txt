# local image with smart cache
docker build -t apollos-ai-base:local --build-arg CACHE_DATE=$(date +%Y-%m-%d:%H:%M:%S)  .

# local image without cache
docker build -t apollos-ai-base:local --no-cache  .

# GHCR push:

# 1. Authenticate (requires a GitHub PAT with write:packages scope)
export GITHUB_TOKEN="ghp_YOUR_TOKEN_HERE"
echo "$GITHUB_TOKEN" | docker login ghcr.io -u jrmatherly --password-stdin

# 2. Create multi-platform builder (one-time setup)
#    --driver-opt network=host is required so BuildKit can reach package mirrors
docker buildx create --name multiarch --driver docker-container --driver-opt network=host --use
# If builds fail with network timeouts, recreate: docker buildx rm multiarch && run the above again

# 3a. Multi-arch push with cache
docker buildx build -t ghcr.io/jrmatherly/apollos-ai-base:latest --platform linux/amd64,linux/arm64 --push --build-arg CACHE_DATE=$(date +%Y-%m-%d:%H:%M:%S) .

# 3b. Multi-arch push without cache
docker buildx build -t ghcr.io/jrmatherly/apollos-ai-base:latest --platform linux/amd64,linux/arm64 --push --build-arg CACHE_DATE=$(date +%Y-%m-%d:%H:%M:%S) --no-cache .

# 3c. Single-arch push (skip --platform to build for local arch only)
docker buildx build -t ghcr.io/jrmatherly/apollos-ai-base:latest --push --build-arg CACHE_DATE=$(date +%Y-%m-%d:%H:%M:%S) .

# plain output
--progress=plain
