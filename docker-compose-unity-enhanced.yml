
# Enhanced Docker Compose for Unity Development with Optimized Qdrant
# This configuration provides:
# - High-performance Qdrant with optimized settings
# - Unity MCP Server for Editor integration
# - Agent Zero with full Unity support
# - Persistent caching and memory

services:
  # ============================================================
  # Agent Zero - Main AI Assistant
  # ============================================================
  agent-zero-unity:
    container_name: agent-zero-unity
    image: agent-zero-unity:latest
    privileged: true
    user: root
    volumes:
      # Persistent workspace
      - agent-zero-data:/a0
      # Host data access
      - ./:/host_data:rw
      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock
      # Unity project mount
      - ./usr/projects:/a0/usr/projects:rw
      # Persistent memory cache
      - unity-memory-cache:/a0/memory
      # Knowledge base
      - ./knowledge:/a0/knowledge:rw
    ports:
      - "50001:80"          # Web UI
      - "22:22"             # SSH access
      - "9000-9009:9000-9009"  # Additional services
    environment:
      # Unity Configuration
      UNITY_PROJECT_NAME: ${UNITY_PROJECT_NAME:-UnityProject}
      UNITY_PROJECT_PATH: /a0/usr/projects/${UNITY_PROJECT_NAME:-UnityProject}
      UNITY_EDITOR_VERSION: ${UNITY_EDITOR_VERSION:-6000.2.10f1}

      # API Keys (from .env)
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GOOGLE_API_KEY: ${GEMINI_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}

      # Docker
      DOCKER_HOST: unix:///var/run/docker.sock
      DOCKER_TLS_VERIFY: "0"

      # Qdrant Configuration - Enhanced for Unity
      QDRANT_URL: http://qdrant-unity:6333
      QDRANT_API_KEY: ""
      A0_MEMORY_BACKEND: qdrant
      A0_QDRANT_URL: http://qdrant-unity:6333
      A0_QDRANT_COLLECTION: agent-zero-unity

      # Agent Zero Configuration
      AGENT_PROFILE: unity_developer
      AGENT_MEMORY_SUBDIR: unity
      AGENT_KNOWLEDGE_SUBDIR: unity

      # Model Configuration
      CHAT_MODEL_PROVIDER: ${CHAT_MODEL_PROVIDER:-Google}
      CHAT_MODEL_NAME: ${CHAT_MODEL_NAME:-gemini-3-pro-preview}
      UTIL_MODEL_PROVIDER: ${UTIL_MODEL_PROVIDER:-Google}
      UTIL_MODEL_NAME: ${UTIL_MODEL_NAME:-gemini-3-pro-preview}
      EMBEDDINGS_MODEL_PROVIDER: ${EMBEDDINGS_MODEL_PROVIDER:-HuggingFace}
      EMBEDDINGS_MODEL_NAME: ${EMBEDDINGS_MODEL_NAME:-sentence-transformers/all-MiniLM-L6-v2}

      # Unity MCP Integration
      UNITY_MCP_URL: http://unity-mcp-server:8080
      UNITY_MCP_ENABLED: "true"

      # Performance tuning
      MEMORY_BATCH_SIZE: "100"
      MEMORY_CACHE_SIZE: "10000"
      EMBEDDING_CACHE_SIZE: "50000"

    restart: unless-stopped
    networks:
      unity-net:
        ipv4_address: 172.30.0.10
    depends_on:
      qdrant-unity:
        condition: service_healthy
      unity-mcp-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 12G
          cpus: '6'
        reservations:
          memory: 4G
          cpus: '2'

  # ============================================================
  # Qdrant Vector Database - Optimized for Unity
  # ============================================================
  qdrant-unity:
    image: qdrant/qdrant:v1.12.1
    container_name: qdrant-unity
    ports:
      - "6333:6333"   # HTTP API
      - "6334:6334"   # gRPC API
    volumes:
      - qdrant-data:/qdrant/storage
      - qdrant-snapshots:/qdrant/snapshots
      - ./conf/qdrant_config.yaml:/qdrant/config/config.yaml:ro
    environment:
      # Service Configuration
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__SERVICE__MAX_REQUEST_SIZE_MB: 64

      # Storage Configuration - Optimized for performance
      QDRANT__STORAGE__WAL_CAPACITY_MB: 128
      QDRANT__STORAGE__PERFORMANCE__OPTIMIZERS_MODE: always

      # Collection Configuration
      QDRANT__COLLECTION__REPLICATION_FACTOR: 1
      QDRANT__COLLECTION__WRITE_CONSISTENCY_FACTOR: 1

      # HNSW Index Configuration - Optimized for Unity knowledge
      QDRANT__HNSW__M: 32
      QDRANT__HNSW__EF_CONSTRUCT: 256
      QDRANT__HNSW__FULL_SCAN_THRESHOLD: 10000

      # Memory Configuration
      QDRANT__STORAGE__MEMMAP_THRESHOLD_KB: 20000
      QDRANT__STORAGE__INDEXING_THRESHOLD: 50000

      # Telemetry
      QDRANT__TELEMETRY_DISABLED: "true"

    restart: unless-stopped
    networks:
      unity-net:
        ipv4_address: 172.30.0.20
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
        reservations:
          memory: 1G
          cpus: '0.5'

  # ============================================================
  # Unity MCP Server - Editor Integration
  # ============================================================
  unity-mcp-server:
    container_name: unity-mcp-server
    image: ivanmurzakdev/unity-mcp-server:latest
    volumes:
      # Mount Unity projects
      - ./usr/projects:/unity-projects:rw
      # Docker socket for Unity operations
      - /var/run/docker.sock:/var/run/docker.sock
      # MCP configuration
      - ./conf/unity_mcp_config.json:/app/config.json:ro
    ports:
      - "9050:8080"   # MCP API
      - "9051:8081"   # WebSocket for real-time events
    environment:
      # Unity Configuration
      UNITY_PROJECTS_PATH: /unity-projects
      UNITY_EDITOR_VERSION: ${UNITY_EDITOR_VERSION:-6000.2.10f1}

      # MCP Server
      MCP_SERVER_PORT: 8080
      MCP_WEBSOCKET_PORT: 8081
      MCP_LOG_LEVEL: info

      # Docker
      DOCKER_HOST: unix:///var/run/docker.sock

      # Integration
      QDRANT_URL: http://qdrant-unity:6333
      AGENT_ZERO_URL: http://agent-zero-unity:80

    restart: unless-stopped
    networks:
      unity-net:
        ipv4_address: 172.30.0.30
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'

  # ============================================================
  # Redis Cache (Optional) - For session and query caching
  # ============================================================
  redis-cache:
    image: redis:7-alpine
    container_name: redis-cache
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    networks:
      unity-net:
        ipv4_address: 172.30.0.40
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

# ============================================================
# Networks
# ============================================================
networks:
  unity-net:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.30.0.0/16
          gateway: 172.30.0.1

# ============================================================
# Volumes
# ============================================================
volumes:
  # Agent Zero persistent data
  agent-zero-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data

  # Unity memory cache
  unity-memory-cache:
    driver: local

  # Qdrant storage
  qdrant-data:
    driver: local

  # Qdrant snapshots for backup
  qdrant-snapshots:
    driver: local

  # Redis cache data
  redis-data:
    driver: local
