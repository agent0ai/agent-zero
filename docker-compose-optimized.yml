
services:
  # Main Agent Zero service with full Docker access
  agent-zero-fresh:
    container_name: agent-zero-fresh
    image: agent-zero-unity:latest
    privileged: true
    user: root
    volumes:
      # OPTIMIZED: All volumes now use D: drive paths
      - D:/GithubRepos/agent-zero/data:/a0
      - D:/GithubRepos/agent-zero:/host_data:rw
      - /var/run/docker.sock:/var/run/docker.sock
      - D:/UnityWorkspaces/MLcreator:/a0/usr/projects/unitymlcreator
    ports:
      - "50001:80"
      - "22:22"
      - "9000-9009:9000-9009"
    environment:
      # Unity ML-Creator project configuration
      UNITY_PROJECT_NAME: "UnityMLcreator"
      UNITY_PROJECT_PATH: "/a0/usr/projects/unitymlcreator"
      UNITY_EDITOR_VERSION: "6000.2.10f1"

      # API Keys (will use Ollama instead)
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GOOGLE_API_KEY: ${GEMINI_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}

      # Docker environment
      DOCKER_HOST: unix:///var/run/docker.sock
      DOCKER_TLS_VERIFY: "0"

      # Qdrant vector database
      QDRANT_URL: "http://qdrant-gpu:6333"
      QDRANT_API_KEY: ""

      # Agent Zero configuration - USE unity_developer profile
      AGENT_PROFILE: "unity_developer"
      AGENT_MEMORY_SUBDIR: "mlcreator"
      AGENT_KNOWLEDGE_SUBDIR: "mlcreator"

      # Use Ollama (local, no API costs)
      CHAT_MODEL_PROVIDER: "Google"
      CHAT_MODEL_NAME: "gemini-3-pro-preview"
      CHAT_MODEL_API_BASE: "http://host.docker.internal:11434"
      UTIL_MODEL_PROVIDER: "Google"
      UTIL_MODEL_NAME: "gemini-3-pro-preview"
      UTIL_MODEL_API_BASE: "http://host.docker.internal:11434"

    restart: unless-stopped
    networks:
      - unity-mlcreator-net
    depends_on:
      - qdrant-gpu
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # OPTIMIZED: Resource limits to prevent memory leaks
    deploy:
      resources:
        limits:
          memory: 6G
          cpus: '3'
        reservations:
          memory: 2G
          cpus: '1'

  # Qdrant vector database - OPTIMIZED
  qdrant-gpu:
    image: qdrant/qdrant:latest
    container_name: qdrant-gpu
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      # OPTIMIZED: Store on D: drive
      - D:/DockerData/qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
      # OPTIMIZED: Limit memory usage
      - QDRANT__SERVICE__MAX_REQUEST_SIZE=10485760
    restart: unless-stopped
    networks:
      - unity-mlcreator-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'

# Custom network
networks:
  unity-mlcreator-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# REMOVED: No need for named volumes, using bind mounts to D: drive
